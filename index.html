<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="KM Pro">
<meta name="theme-color" content="#080909">
<title>KM Pro</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
/* â”€â”€â”€ RESET â”€â”€â”€ */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
html,body{height:100%;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}

/* â”€â”€â”€ PIN â”€â”€â”€ */
.pin-screen{position:fixed;inset:0;z-index:9998;background:var(--ink);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:40px 32px;transition:opacity .4s}
.pin-screen.hidden{opacity:0;pointer-events:none}
.pin-logo{font-family:'Cormorant Garamond',serif;font-size:42px;font-weight:600;
  color:var(--gold);margin-bottom:8px;letter-spacing:-.01em}
.pin-sub{font-size:13px;color:var(--fg3);margin-bottom:48px;text-align:center;line-height:1.5}
.pin-dots{display:flex;gap:14px;margin-bottom:40px;height:14px;align-items:center}
.pin-dot{width:12px;height:12px;border-radius:50%;background:var(--line2);
  border:1.5px solid var(--fg3);transition:all .15s}
.pin-dot.filled{background:var(--gold);border-color:var(--gold);transform:scale(1.15)}
.pin-dot.error{background:var(--ruby);border-color:var(--ruby);animation:shake .35s ease}
.pin-pad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;width:100%;max-width:280px}
.pin-key{background:var(--ink3);border:1px solid var(--line2);border-radius:16px;
  padding:18px;font-size:22px;font-weight:600;font-family:'Plus Jakarta Sans',sans-serif;
  color:var(--fg);cursor:pointer;text-align:center;transition:all .12s;
  -webkit-user-select:none;user-select:none}
.pin-key:active{background:var(--ink5);transform:scale(.93);border-color:var(--gold-ring)}
.pin-key.del{font-size:18px;color:var(--fg3)}
.pin-key.empty{visibility:hidden}
.pin-hint{margin-top:28px;font-size:12px;color:var(--fg3);text-align:center;line-height:1.5}
.pin-change{margin-top:12px;font-size:12px;color:var(--gold);cursor:pointer;
  text-decoration:underline;text-underline-offset:3px}

/* â”€â”€â”€ TOKENS â”€â”€â”€ */
:root{
  --ink:       #080909;
  --ink2:      #0e1012;
  --ink3:      #141618;
  --ink4:      #1a1d20;
  --ink5:      #22262a;
  --line:      #1f2327;
  --line2:     #2a2f35;
  --fg:        #eef0f3;
  --fg2:       #9aa0aa;
  --fg3:       #4a5260;
  --gold:      #c8a96e;
  --gold2:     #e8c98a;
  --gold3:     #f5dfa8;
  --gold-bg:   rgba(200,169,110,.10);
  --gold-ring: rgba(200,169,110,.20);
  --emerald:   #4db887;
  --em-bg:     rgba(77,184,135,.10);
  --ruby:      #e05555;
  --ruby-bg:   rgba(224,85,85,.10);
  --sapphire:  #5c8fe0;
  --sap-bg:    rgba(92,143,224,.10);
  --safe-t:    env(safe-area-inset-top,0px);
  --safe-b:    env(safe-area-inset-bottom,0px);
  --r:         16px;
  --r-sm:      10px;
  --shadow:    0 8px 40px rgba(0,0,0,.55);
  --shadow-sm: 0 2px 12px rgba(0,0,0,.35);
}

/* â”€â”€â”€ APP SHELL â”€â”€â”€ */
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--ink);color:var(--fg);overflow:hidden}
.app{display:flex;flex-direction:column;height:100dvh}
.screens{flex:1;overflow:hidden;position:relative}
.screen{position:absolute;inset:0;overflow-y:auto;-webkit-overflow-scrolling:touch;display:none;
  padding-top:calc(var(--safe-t) + 0px);padding-bottom:calc(72px + var(--safe-b))}
.screen.active{display:block;animation:screenIn .28s cubic-bezier(.22,.8,.36,1)}
@keyframes screenIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.pad{padding:0 20px}

/* â”€â”€â”€ NAV â”€â”€â”€ */
.nav{
  background:rgba(8,9,9,.85);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-top:1px solid var(--line);padding-bottom:var(--safe-b);
  display:grid;grid-template-columns:repeat(5,1fr);z-index:100;flex-shrink:0;
}
.ni{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;
  padding:10px 4px 9px;border:none;background:none;color:var(--fg3);
  font-family:'Plus Jakarta Sans',sans-serif;font-size:9.5px;font-weight:600;
  letter-spacing:.03em;text-transform:uppercase;cursor:pointer;position:relative;
  transition:color .2s;-webkit-user-select:none}
.ni svg{width:22px;height:22px;stroke-width:1.6;transition:transform .2s}
.ni.active{color:var(--gold)}
.ni.active svg{transform:scale(1.15)}
.ni-dot{position:absolute;top:8px;right:calc(50% - 16px);width:7px;height:7px;
  border-radius:50%;background:var(--ruby);border:1.5px solid var(--ink);display:none}

/* â”€â”€â”€ FAB â”€â”€â”€ */
.fab{position:fixed;bottom:calc(80px + var(--safe-b));right:20px;
  width:52px;height:52px;border-radius:50%;border:none;cursor:pointer;
  background:linear-gradient(135deg,var(--gold2),var(--gold));
  color:var(--ink);font-size:24px;font-weight:300;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 4px 24px rgba(200,169,110,.45);z-index:90;
  transition:transform .18s,box-shadow .18s;font-family:'Plus Jakarta Sans',sans-serif}
.fab:active{transform:scale(.92);box-shadow:0 2px 12px rgba(200,169,110,.3)}

/* â”€â”€â”€ PAGE HEADERS â”€â”€â”€ */
.ph{padding:20px 20px 16px;display:flex;align-items:flex-end;justify-content:space-between}
.ph-title{font-family:'Cormorant Garamond',serif;font-size:32px;font-weight:600;
  line-height:1;letter-spacing:-.01em;color:var(--fg)}
.ph-sub{font-size:12px;color:var(--fg3);margin-top:4px;font-weight:500}
.ph-action{background:var(--ink4);border:1px solid var(--line2);border-radius:var(--r-sm);
  padding:7px 14px;font-size:12px;font-weight:600;color:var(--fg2);cursor:pointer;
  font-family:'Plus Jakarta Sans',sans-serif;letter-spacing:.02em;transition:all .15s}
.ph-action:active{background:var(--ink5);color:var(--fg)}

/* â”€â”€â”€ KPI GRID â”€â”€â”€ */
.kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:0 20px 16px}
.kpi{background:var(--ink3);border:1px solid var(--line);border-radius:var(--r);
  padding:18px 16px;position:relative;overflow:hidden;cursor:default}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:1.5px}
.kpi.c-gold::before{background:linear-gradient(90deg,var(--gold),var(--gold3))}
.kpi.c-em::before{background:var(--emerald)}
.kpi.c-ruby::before{background:var(--ruby)}
.kpi.c-sap::before{background:var(--sapphire)}
.kpi-l{font-size:9.5px;font-weight:700;color:var(--fg3);letter-spacing:.08em;
  text-transform:uppercase;margin-bottom:8px}
.kpi-v{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:600;
  line-height:1;color:var(--fg)}
.kpi-u{font-size:13px;font-family:'Plus Jakarta Sans',sans-serif;font-weight:400;color:var(--fg3)}
.kpi-s{font-size:10.5px;color:var(--fg3);margin-top:5px;font-weight:500}

/* â”€â”€â”€ SECTION LABEL â”€â”€â”€ */
.sl{padding:0 20px 10px;display:flex;align-items:center;justify-content:space-between}
.sl-t{font-size:11px;font-weight:700;color:var(--fg3);letter-spacing:.07em;text-transform:uppercase}
.sl-a{font-size:12px;font-weight:600;color:var(--gold);cursor:pointer;background:none;border:none;
  font-family:'Plus Jakarta Sans',sans-serif}

/* â”€â”€â”€ TRAJET CARD â”€â”€â”€ */
.tc{background:var(--ink3);border:1px solid var(--line);border-radius:var(--r);
  margin:0 20px 10px;padding:16px;cursor:pointer;transition:border-color .15s,background .15s;
  position:relative;overflow:hidden}
.tc:active{background:var(--ink4);border-color:var(--line2)}
.tc-route{font-size:14px;font-weight:600;color:var(--fg);white-space:nowrap;
  overflow:hidden;text-overflow:ellipsis;margin-bottom:5px;letter-spacing:-.01em}
.tc-meta{font-size:11.5px;color:var(--fg3);font-weight:500}
.tc-amount{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600;
  color:var(--gold);white-space:nowrap}
.tc-paid{font-size:10px;color:var(--sapphire);text-align:right;margin-top:2px;font-weight:600}

/* â”€â”€â”€ BADGE â”€â”€â”€ */
.badge{display:inline-flex;align-items:center;gap:3px;padding:3px 9px 3px 7px;
  border-radius:99px;font-size:10px;font-weight:700;letter-spacing:.02em}
.b-wait{background:var(--gold-bg);color:var(--gold2)}
.b-part{background:var(--sap-bg);color:var(--sapphire)}
.b-done{background:var(--em-bg);color:var(--emerald)}

/* â”€â”€â”€ PROGRESS â”€â”€â”€ */
.prog-wrap{height:4px;background:var(--ink5);border-radius:99px;overflow:hidden;margin-top:8px}
.prog-fill{height:100%;border-radius:99px;
  background:linear-gradient(90deg,var(--gold),var(--gold3));transition:width .6s ease}

/* â”€â”€â”€ SEGMENT â”€â”€â”€ */
.seg{display:flex;background:var(--ink3);border:1px solid var(--line);
  border-radius:var(--r-sm);padding:3px;gap:2px;margin:0 20px 16px;overflow-x:auto;
  scrollbar-width:none;-ms-overflow-style:none}
.seg::-webkit-scrollbar{display:none}
.seg-b{flex:0 0 auto;padding:7px 14px;border:none;background:transparent;
  color:var(--fg3);font-family:'Plus Jakarta Sans',sans-serif;font-size:12px;
  font-weight:600;border-radius:7px;cursor:pointer;transition:all .15s;white-space:nowrap}
.seg-b.active{background:var(--ink5);color:var(--fg);box-shadow:var(--shadow-sm)}

/* â”€â”€â”€ SHEET â”€â”€â”€ */
.overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.7);
  backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);
  opacity:0;pointer-events:none;transition:opacity .25s}
.overlay.open{opacity:1;pointer-events:all}
.sheet{position:absolute;bottom:0;left:0;right:0;
  background:var(--ink2);border-radius:24px 24px 0 0;
  border-top:1px solid var(--line2);
  padding-bottom:calc(var(--safe-b) + 20px);
  transform:translateY(100%);
  transition:transform .35s cubic-bezier(.32,.72,0,1);
  max-height:96dvh;overflow-y:auto;-webkit-overflow-scrolling:touch}
.overlay.open .sheet{transform:translateY(0)}
.drag-pill{width:40px;height:4px;border-radius:99px;background:var(--line2);
  margin:14px auto 0}
.sh{padding:16px 20px 12px;display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--line);position:sticky;top:0;background:var(--ink2);z-index:10}
.sh-title{font-family:'Cormorant Garamond',serif;font-size:24px;font-weight:600}
.sh-close{width:30px;height:30px;border-radius:50%;background:var(--ink4);
  border:none;color:var(--fg3);font-size:16px;display:flex;align-items:center;
  justify-content:center;cursor:pointer;transition:all .15s}
.sh-close:active{background:var(--ink5);color:var(--fg)}
.sb{padding:20px}
.sf{padding:0 20px 4px;display:flex;flex-direction:column;gap:10px}

/* â”€â”€â”€ FORMS â”€â”€â”€ */
.fl{font-size:11px;font-weight:700;color:var(--fg3);letter-spacing:.07em;
  text-transform:uppercase;display:block;margin-bottom:7px}
.fi{width:100%;background:var(--ink4);border:1px solid var(--line2);
  border-radius:12px;padding:13px 14px;color:var(--fg);
  font-family:'Plus Jakarta Sans',sans-serif;font-size:15px;
  transition:border-color .2s,box-shadow .2s;-webkit-appearance:none;appearance:none}
.fi:focus{outline:none;border-color:var(--gold);box-shadow:0 0 0 3px var(--gold-ring)}
.fi.field-err{border-color:var(--ruby)!important;box-shadow:0 0 0 3px rgba(224,85,85,.18)!important;animation:errShake .35s ease}
@keyframes errShake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-5px)}40%,80%{transform:translateX(5px)}}
.fi::placeholder{color:var(--fg3)}
.fi-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.fg-s{margin-bottom:14px}

/* â”€â”€â”€ AUTOCOMPLETE â”€â”€â”€ */
.ac-wrap{position:relative}
.ac-list{position:absolute;top:calc(100% + 4px);left:0;right:0;
  background:var(--ink4);border:1px solid var(--line2);border-radius:14px;
  z-index:500;overflow:hidden;box-shadow:var(--shadow);max-height:240px;overflow-y:auto;
  scrollbar-width:none;display:none}
.ac-list::-webkit-scrollbar{display:none}
.ac-list.show{display:block;animation:dropIn .18s cubic-bezier(.22,.8,.36,1)}
@keyframes dropIn{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.ac-item{padding:12px 14px;cursor:pointer;transition:background .1s;
  border-bottom:1px solid var(--line)}
.ac-item:last-child{border-bottom:none}
.ac-item:active{background:var(--ink5)}
.ac-main{font-size:13px;font-weight:600;color:var(--fg);margin-bottom:2px}
.ac-sub{font-size:11px;color:var(--fg3)}
.ac-loader{padding:14px;text-align:center;font-size:12px;color:var(--fg3)}

/* â”€â”€â”€ GPS WRAP â”€â”€â”€ */
.gps-wrap{position:relative}
.gps-wrap .fi{padding-right:46px}
.gps-btn{position:absolute;right:10px;top:50%;transform:translateY(-50%);
  width:30px;height:30px;border-radius:8px;background:var(--ink5);
  border:1px solid var(--line2);display:flex;align-items:center;justify-content:center;
  font-size:15px;cursor:pointer;transition:all .15s;z-index:2}
.gps-btn:active{background:var(--gold-bg);border-color:var(--gold-ring)}
.gps-btn.loading{animation:pulse .9s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

/* â”€â”€â”€ FAV CHIPS â”€â”€â”€ */
.favs{display:flex;flex-wrap:nowrap;overflow-x:auto;gap:7px;margin-bottom:10px;
  scrollbar-width:none;-ms-overflow-style:none}
.favs::-webkit-scrollbar{display:none}
.fav-chip{flex:0 0 auto;display:flex;align-items:center;gap:5px;
  padding:5px 12px;background:var(--ink4);border:1px solid var(--line2);
  border-radius:99px;font-size:12px;font-weight:600;color:var(--fg2);
  cursor:pointer;transition:all .15s;white-space:nowrap}
.fav-chip:active{background:var(--gold-bg);border-color:var(--gold-ring);color:var(--gold2)}

/* â”€â”€â”€ CALC PREVIEW â”€â”€â”€ */
.calc-box{background:var(--gold-bg);border:1px solid var(--gold-ring);
  border-radius:12px;padding:14px 16px;font-size:13px;color:var(--gold2);
  line-height:1.6;margin-bottom:14px;transition:all .3s}
.calc-box.loading{color:var(--fg3);background:var(--ink4);border-color:var(--line2);
  animation:pulse .9s infinite}
.calc-big{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600;
  color:var(--gold3);display:block;margin-top:4px}

/* â”€â”€â”€ MAP â”€â”€â”€ */
.map-wrap{height:200px;border-radius:14px;overflow:hidden;border:1px solid var(--line2);
  margin-bottom:14px;display:none;position:relative}
.map-wrap.show{display:block;animation:fadeIn .4s ease}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
#trip-map{height:100%;width:100%}
.leaflet-container{background:var(--ink3)!important;font-family:'Plus Jakarta Sans',sans-serif!important}
.leaflet-tile{filter:brightness(.55) saturate(.6) hue-rotate(5deg)}

/* â”€â”€â”€ ROUTE CALC BTN â”€â”€â”€ */
/* route-btn removed */

/* â”€â”€â”€ BUTTONS â”€â”€â”€ */
.btn{display:flex;align-items:center;justify-content:center;gap:8px;border:none;
  cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;font-weight:600;
  border-radius:14px;transition:all .15s;-webkit-user-select:none}
.btn:active{transform:scale(.97);opacity:.9}
.btn-gold{background:linear-gradient(135deg,var(--gold2),var(--gold));color:var(--ink);
  font-size:15px;padding:15px 20px;width:100%;letter-spacing:.01em}
.btn-ink{background:var(--ink4);color:var(--fg2);border:1px solid var(--line2);
  font-size:13px;padding:11px 16px}
.btn-danger{background:var(--ruby-bg);color:var(--ruby);font-size:13px;padding:11px 16px}
.btn-em{background:var(--em-bg);color:var(--emerald);font-size:13px;padding:11px 16px}

/* â”€â”€â”€ DETAIL ROWS â”€â”€â”€ */
.dr{display:flex;justify-content:space-between;align-items:center;padding:11px 0;
  border-bottom:1px solid var(--line);font-size:13px}
.dr:last-child{border-bottom:none}
.dr-l{color:var(--fg3);font-weight:500}
.dr-v{font-weight:600;text-align:right;max-width:60%;color:var(--fg)}

/* â”€â”€â”€ CHARTS â”€â”€â”€ */
.chart-card{background:var(--ink3);border:1px solid var(--line);border-radius:var(--r);
  padding:18px 16px;margin:0 20px 12px}
.chart-ttl{font-size:11px;font-weight:700;color:var(--fg3);letter-spacing:.07em;
  text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:6px}
.chart-ttl span{width:8px;height:8px;border-radius:50%;display:inline-block}
/* Fix chart resize bug - canvas must have explicit container height */
.chart-box{position:relative;height:160px;width:100%}

/* â”€â”€â”€ REMB CARD â”€â”€â”€ */
.remb-card{background:var(--ink3);border:1px solid var(--line);border-radius:var(--r);
  margin:0 20px 12px;overflow:hidden}
.remb-top{padding:16px;display:flex;justify-content:space-between;align-items:center;
  border-bottom:1px solid var(--line)}
.remb-hist{padding:4px 0}
.rh-item{display:flex;justify-content:space-between;align-items:center;
  padding:12px 16px;border-bottom:1px solid var(--line)}
.rh-item:last-child{border-bottom:none}
.rh-amount{font-family:'Cormorant Garamond',serif;font-size:20px;
  font-weight:600;color:var(--emerald)}

/* â”€â”€â”€ EMPTY â”€â”€â”€ */
.empty{text-align:center;padding:56px 24px;color:var(--fg3)}
.empty-ico{font-size:48px;margin-bottom:14px;opacity:.6}
.empty h3{font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--fg2);
  margin-bottom:8px;font-weight:600}
.empty p{font-size:13px;line-height:1.6;max-width:260px;margin:0 auto}

/* â”€â”€â”€ TOAST â”€â”€â”€ */
.toast-wrap{position:fixed;top:calc(var(--safe-t) + 14px);left:16px;right:16px;
  z-index:9999;pointer-events:none;display:flex;flex-direction:column;gap:8px}
.toast{background:var(--ink4);border:1px solid var(--line2);border-radius:14px;
  padding:13px 16px;font-size:13px;font-weight:600;display:flex;align-items:center;
  gap:10px;box-shadow:var(--shadow);pointer-events:all;
  animation:slideDown .3s cubic-bezier(.34,1.56,.64,1)}
@keyframes slideDown{from{opacity:0;transform:translateY(-20px) scale(.95)}}
.toast.ok{border-left:3px solid var(--emerald)}
.toast.err{border-left:3px solid var(--ruby)}
.toast.tip{border-left:3px solid var(--gold)}

/* â”€â”€â”€ INSTALL HINT â”€â”€â”€ */
.hint{background:var(--gold-bg);border:1px solid var(--gold-ring);border-radius:14px;
  padding:13px 16px;margin:0 20px 16px;font-size:12.5px;color:var(--gold2);
  line-height:1.5;display:none;align-items:center;gap:12px}
.hint.show{display:flex}

/* â”€â”€â”€ EMOJI GRID â”€â”€â”€ */
.emoji-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:4px}
.eg-item{display:flex;flex-direction:column;align-items:center;gap:3px;
  padding:10px 4px;background:var(--ink4);border:1.5px solid var(--line2);
  border-radius:12px;cursor:pointer;transition:all .15s;font-size:20px}
.eg-item span{font-size:9px;font-weight:600;color:var(--fg3);letter-spacing:.02em;text-align:center}
.eg-item.sel{border-color:var(--gold);background:var(--gold-bg)}
.eg-item.sel span{color:var(--gold2)}
.eg-item:active{transform:scale(.93)}

/* â”€â”€â”€ MISC â”€â”€â”€ */
.divider{height:1px;background:var(--line);margin:16px 0}
.section-header{font-size:11px;font-weight:700;color:var(--fg3);letter-spacing:.07em;
  text-transform:uppercase;padding:14px 0 8px}
select.fi option{background:var(--ink4)}
.gold{color:var(--gold)}
.emerald{color:var(--emerald)}
.ruby{color:var(--ruby)}
.sapphire{color:var(--sapphire)}
.serif{font-family:'Cormorant Garamond',serif}



/* â”€â”€â”€ PRINT â”€â”€â”€ */

/* â”€â”€â”€ PIN LOCK â”€â”€â”€ */
#pin-screen{position:fixed;inset:0;z-index:9000;background:var(--ink);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  padding:40px 32px;transition:opacity .3s}
#pin-screen.hidden{opacity:0;pointer-events:none}
.pin-logo{font-family:'Cormorant Garamond',serif;font-size:36px;font-weight:600;
  color:var(--fg);margin-bottom:6px;letter-spacing:-.01em}
.pin-sub{font-size:13px;color:var(--fg3);margin-bottom:48px;font-weight:500}
.pin-dots{display:flex;gap:14px;margin-bottom:48px}
.pin-dot{width:14px;height:14px;border-radius:50%;background:var(--ink5);
  border:1.5px solid var(--line2);transition:all .15s}
.pin-dot.filled{background:var(--gold);border-color:var(--gold)}
.pin-dot.error{background:var(--ruby);border-color:var(--ruby)}
.pin-pad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;width:100%;max-width:280px}
.pin-key{background:var(--ink3);border:1px solid var(--line2);border-radius:16px;
  padding:18px 10px;font-size:24px;font-weight:600;font-family:'Cormorant Garamond',serif;
  color:var(--fg);cursor:pointer;text-align:center;
  transition:background .12s,transform .1s,border-color .15s;-webkit-user-select:none;
  box-shadow:0 2px 8px rgba(0,0,0,.3)}
.pin-key:active{background:var(--ink5);transform:scale(.94);border-color:var(--gold-ring)}
.pin-key.del{font-size:18px;font-family:'Plus Jakarta Sans',sans-serif;color:var(--fg3)}
.pin-key.empty{background:transparent;border-color:transparent;box-shadow:none;cursor:default}
.pin-err{font-size:13px;color:var(--ruby);height:20px;text-align:center;margin-bottom:16px;
  font-weight:600;transition:opacity .2s}
.pin-setup-wrap{width:100%;max-width:280px;text-align:center;margin-bottom:32px}
.pin-setup-label{font-size:13px;color:var(--gold2);font-weight:600;margin-bottom:16px}


/* â”€â”€â”€ FIELD VALIDATION â”€â”€â”€ */
.fi.field-err{border-color:var(--ruby)!important;box-shadow:0 0 0 3px rgba(224,85,85,.18)!important;animation:shake .35s ease}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
.field-err-label{color:var(--ruby)!important}
@media print{
  @page{margin:18mm 15mm;size:A4}
  .nav,.fab,.overlay,.toast-wrap,.ph-action,.btn{display:none!important}
  body{background:#fff!important;color:#1a1a1a!important;overflow:visible;font-family:'Plus Jakarta Sans',sans-serif;font-size:11pt}
  .screen{position:static!important;display:block!important;overflow:visible!important;padding:0!important}
  #s-rapport{display:block!important}
  #report-out{all:unset;display:block}
  .print-doc{display:block!important}
  .no-print{display:none!important}
}
.print-doc{display:none}
</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<div id="pin-screen">
  <div class="pin-logo">KM Pro</div>
  <div class="pin-sub" id="pin-label">Entrez votre code</div>
  <div class="pin-dots" id="pin-dots">
    <div class="pin-dot" id="pd0"></div>
    <div class="pin-dot" id="pd1"></div>
    <div class="pin-dot" id="pd2"></div>
    <div class="pin-dot" id="pd3"></div>
  </div>
  <div class="pin-err" id="pin-err"></div>
  <div class="pin-pad" id="pin-pad">
    <div class="pin-key" onclick="pinKey('1')">1</div>
    <div class="pin-key" onclick="pinKey('2')">2</div>
    <div class="pin-key" onclick="pinKey('3')">3</div>
    <div class="pin-key" onclick="pinKey('4')">4</div>
    <div class="pin-key" onclick="pinKey('5')">5</div>
    <div class="pin-key" onclick="pinKey('6')">6</div>
    <div class="pin-key" onclick="pinKey('7')">7</div>
    <div class="pin-key" onclick="pinKey('8')">8</div>
    <div class="pin-key" onclick="pinKey('9')">9</div>
    <div class="pin-key empty"></div>
    <div class="pin-key" onclick="pinKey('0')">0</div>
    <div class="pin-key del" onclick="pinDel()">âŒ«</div>
  </div>
</div>



<div class="app">
<div class="screens">

<!-- â•â• HOME â•â• -->
<div class="screen active" id="s-home">
  <div style="height:calc(var(--safe-t) + 8px)"></div>
  <div class="ph">
    <div>
      <div class="ph-title" id="greeting">Bonjour</div>
      <div class="ph-sub" id="greeting-sub">ConformitÃ© du Patrimoine</div>
    </div>
    <div id="avatar" onclick="openSheet('sh-profil')"
      style="width:42px;height:42px;border-radius:50%;background:var(--gold-bg);
      border:1.5px solid var(--gold-ring);display:flex;align-items:center;justify-content:center;
      font-weight:700;color:var(--gold);font-size:14px;cursor:pointer;letter-spacing:.02em">?</div>
  </div>
  <div class="hint" id="install-hint">
    <span style="font-size:20px;flex-shrink:0">ğŸ“²</span>
    <span>Safari â†’ <strong>Partager</strong> â†’ <strong>Sur l'Ã©cran d'accueil</strong> pour installer l'app</span>
  </div>
  <div class="kpi-grid" id="kpi-home"></div>
  <div class="sl"><span class="sl-t">Derniers trajets</span><button class="sl-a" onclick="switchScreen('trajets')">Voir tout â†’</button></div>
  <div id="home-list"></div>
</div>

<!-- â•â• TRAJETS â•â• -->
<div class="screen" id="s-trajets">
  <div style="height:calc(var(--safe-t) + 8px)"></div>
  <div class="ph">
    <div><div class="ph-title">Trajets</div><div class="ph-sub" id="trajets-sub"></div></div>
    <button class="ph-action" onclick="openSheet('sh-export')">Exporter</button>
  </div>
  <div class="seg" id="seg-mois"></div>
  <div id="trajets-list"></div>
</div>

<!-- â•â• VERSEMENTS â•â• -->
<div class="screen" id="s-remb">
  <div style="height:calc(var(--safe-t) + 8px)"></div>
  <div class="ph">
    <div><div class="ph-title">Versements</div><div class="ph-sub">Remboursements progressifs</div></div>
  </div>
  <div id="remb-content"></div>
</div>

<!-- â•â• STATS â•â• -->
<div class="screen" id="s-stats">
  <div style="height:calc(var(--safe-t) + 8px)"></div>
  <div class="ph">
    <div><div class="ph-title">Statistiques</div><div class="ph-sub" id="stats-sub"></div></div>
    <select class="fi" id="stats-year" onchange="renderStats()"
      style="width:auto;padding:7px 12px;font-size:13px;border-radius:var(--r-sm)">
      <option value="2026">2026</option><option value="2025">2025</option>
    </select>
  </div>
  <div class="chart-card">
    <div class="chart-ttl"><span style="background:var(--gold)"></span>KilomÃ¨tres par mois</div>
    <div style="position:relative;height:160px"><canvas id="c-km"></canvas></div>
  </div>
  <div class="chart-card">
    <div class="chart-ttl"><span style="background:var(--emerald)"></span>IndemnitÃ©s (â‚¬)</div>
    <div style="position:relative;height:160px"><canvas id="c-ind"></canvas></div>
  </div>
  <div class="pad" style="padding-bottom:8px">
    <div class="section-header">RÃ©capitulatif</div>
  </div>
  <div id="stats-recap" style="margin:0 20px 12px;background:var(--ink3);border:1px solid var(--line);border-radius:var(--r);padding:4px 16px"></div>
  <div class="pad"><div class="section-header">Trajets frÃ©quents</div></div>
  <div id="stats-freq" style="margin:0 20px 20px;background:var(--ink3);border:1px solid var(--line);border-radius:var(--r);padding:4px 16px"></div>
</div>

<!-- â•â• RAPPORT â•â• -->
<div class="screen" id="s-rapport">
  <div style="height:calc(var(--safe-t) + 8px)"></div>
  <div class="ph">
    <div><div class="ph-title">Rapport</div><div class="ph-sub">Note de frais fiscale</div></div>
  </div>
  <div class="pad">
    <div class="fi-row">
      <div class="fg-s" style="margin-bottom:0">
        <label class="fl">PÃ©riode</label>
        <select class="fi" id="rap-per" style="padding:10px 12px">
          <option value="mois">Mois en cours</option>
          <option value="trim1">T1 â€” Jan/Mar</option>
          <option value="trim2">T2 â€” Avr/Jun</option>
          <option value="trim3">T3 â€” Jul/Sep</option>
          <option value="trim4">T4 â€” Oct/DÃ©c</option>
          <option value="annee">AnnÃ©e entiÃ¨re</option>
        </select>
      </div>
      <div class="fg-s" style="margin-bottom:0">
        <label class="fl">AnnÃ©e</label>
        <select class="fi" id="rap-yr" style="padding:10px 12px">
          <option value="2026">2026</option><option value="2025">2025</option>
        </select>
      </div>
    </div>
    <button class="btn btn-gold" style="margin-top:14px;margin-bottom:20px" onclick="genReport()">GÃ©nÃ©rer le rapport</button>
  </div>
  <div id="report-out"></div>
</div>

</div><!-- /screens -->

<!-- â•â• NAV BAR â•â• -->
<nav class="nav">
  <button class="ni active" id="ni-home" onclick="switchScreen('home')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    Accueil
  </button>
  <button class="ni" id="ni-trajets" onclick="switchScreen('trajets')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
    Trajets
    <span class="ni-dot" id="dot-trajets"></span>
  </button>
  <button class="ni" id="ni-remb" onclick="switchScreen('remb')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
    Versements
  </button>
  <button class="ni" id="ni-stats" onclick="switchScreen('stats')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
    Stats
  </button>
  <button class="ni" id="ni-rapport" onclick="switchScreen('rapport')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
    Rapport
  </button>
</nav>
</div><!-- /app -->

<button class="fab" id="fab" onclick="openNewTrajet()">+</button>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SHEET: NOUVEAU TRAJET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="sh-trajet">
<div class="sheet">
  <div class="drag-pill"></div>
  <div class="sh">
    <div class="sh-title" id="sh-trajet-ttl">Nouveau trajet</div>
    <button class="sh-close" onclick="closeSheet('sh-trajet')">âœ•</button>
  </div>
  <div class="sb">
    <div class="fi-row">
      <div class="fg-s" style="margin-bottom:0">
        <label class="fl">Date *</label>
        <input type="date" class="fi" id="t-date">
      </div>
      <div class="fg-s" style="margin-bottom:0">
        <label class="fl">AssociÃ© *</label>
        <select class="fi" id="t-assoc" onchange="calcPreview()"></select>
      </div>
    </div>

    <div class="fg-s">
      <label class="fl">ğŸ“ DÃ©part *</label>
      <div class="favs" id="favs-dep"></div>
      <div class="ac-wrap gps-wrap">
        <input type="text" class="fi" id="t-dep" placeholder="Adresse de dÃ©partâ€¦"
          autocomplete="off" oninput="acSearch('t-dep','ac-dep','dep')">
        <button class="gps-btn" id="gps-dep" onclick="useGPS('dep')" title="Ma position">ğŸ“</button>
        <div class="ac-list" id="ac-dep"></div>
      </div>
    </div>

    <div class="fg-s">
      <label class="fl">ğŸ ArrivÃ©e *</label>
      <div class="favs" id="favs-arr"></div>
      <div class="ac-wrap gps-wrap">
        <input type="text" class="fi" id="t-arr" placeholder="Adresse d'arrivÃ©eâ€¦"
          autocomplete="off" oninput="acSearch('t-arr','ac-arr','arr')">
        <button class="gps-btn" id="gps-arr" onclick="useGPS('arr')" title="Ma position">ğŸ“</button>
        <div class="ac-list" id="ac-arr"></div>
      </div>
    </div>

    <div class="map-wrap" id="map-wrap"><div id="trip-map"></div></div>

    <div class="calc-box" id="calc-box">Saisissez les km pour voir l'indemnitÃ© calculÃ©e</div>

    <div class="fg-s">
      <label class="fl">Motif professionnel *</label>
      <input type="text" class="fi" id="t-motif" placeholder="ex : Visite chantier client Martinâ€¦">
    </div>

    <div class="fi-row">
      <div class="fg-s" style="margin-bottom:0">
        <label class="fl">KilomÃ¨tres</label>
        <input type="number" class="fi" id="t-km" min="0" step="1" placeholder="0"
          inputmode="decimal" oninput="calcPreview()">
      </div>
      <div class="fg-s" style="margin-bottom:0">
        <label class="fl">Type</label>
        <select class="fi" id="t-ar" onchange="calcPreview()">
          <option value="2" selected>Aller-retour Ã—2</option>
          <option value="1">Aller simple</option>
        </select>
      </div>
    </div>
    <div class="fi-row" style="margin-top:14px">
      <div class="fg-s" style="margin-bottom:0">
        <label class="fl">Puissance fiscale</label>
        <select class="fi" id="t-cv" onchange="calcPreview()">
          <option value="3">3 CV âˆ’</option><option value="4">4 CV</option>
          <option value="5" selected>5 CV</option><option value="6">6 CV</option>
          <option value="7">7 CV +</option>
        </select>
      </div>
      <div class="fg-s" style="margin-bottom:0">
        <label class="fl">VÃ©hicule</label>
        <input type="text" class="fi" id="t-veh" placeholder="AB-123-CD">
      </div>
    </div>
    <div class="fg-s" style="margin-top:14px">
      <label class="fl">RÃ©fÃ©rence / Notes</label>
      <input type="text" class="fi" id="t-notes" placeholder="NÂ° chantier, bon de commandeâ€¦">
    </div>
  </div>
  <div class="sf">
    <button class="btn btn-gold" onclick="saveTrajet()">Enregistrer le trajet</button>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SHEET: DÃ‰TAIL TRAJET
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="sh-detail">
<div class="sheet">
  <div class="drag-pill"></div>
  <div class="sh">
    <div class="sh-title">DÃ©tail</div>
    <button class="sh-close" onclick="closeSheet('sh-detail')">âœ•</button>
  </div>
  <div class="sb" id="detail-body"></div>
  <div class="sf" id="detail-foot"></div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SHEET: VERSEMENT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="sh-remb">
<div class="sheet">
  <div class="drag-pill"></div>
  <div class="sh">
    <div class="sh-title">Enregistrer un versement</div>
    <button class="sh-close" onclick="closeSheet('sh-remb')">âœ•</button>
  </div>
  <div class="sb">
    <div class="fi-row">
      <div class="fg-s" style="margin-bottom:0">
        <label class="fl">AssociÃ© *</label>
        <select class="fi" id="r-assoc" onchange="rembPreview()"></select>
      </div>
      <div class="fg-s" style="margin-bottom:0">
        <label class="fl">Date *</label>
        <input type="date" class="fi" id="r-date">
      </div>
    </div>
    <div class="fi-row" style="margin-top:14px">
      <div class="fg-s" style="margin-bottom:0">
        <label class="fl">Montant (â‚¬) *</label>
        <input type="number" class="fi" id="r-amt" min="0" step="0.01"
          placeholder="0.00" inputmode="decimal"
          oninput="this._manual=true;rembPreview()"
          onchange="this._manual=true">
      </div>
      <div class="fg-s" style="margin-bottom:0">
        <label class="fl">Mode</label>
        <select class="fi" id="r-mode">
          <option>Virement</option><option>ChÃ¨que</option><option>EspÃ¨ces</option>
        </select>
      </div>
    </div>
    <div class="fg-s" style="margin-top:14px">
      <label class="fl">RÃ©fÃ©rence</label>
      <input type="text" class="fi" id="r-ref" placeholder="NÂ° virement ou commentaire">
    </div>
    <div class="calc-box" id="remb-prev" style="margin-bottom:14px">SÃ©lectionnez un associÃ©</div>
    <div class="fg-s">
      <label class="fl">Appliquer sur ces trajets</label>
      <div id="remb-trips"
        style="background:var(--ink4);border:1px solid var(--line2);border-radius:12px;
        max-height:200px;overflow-y:auto;padding:4px"></div>
    </div>
  </div>
  <div class="sf">
    <button class="btn btn-gold" onclick="saveRemb()">Enregistrer le versement</button>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SHEET: EXPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="sh-export">
<div class="sheet">
  <div class="drag-pill"></div>
  <div class="sh">
    <div class="sh-title">Exporter</div>
    <button class="sh-close" onclick="closeSheet('sh-export')">âœ•</button>
  </div>
  <div class="sb">
    <p style="font-size:13px;color:var(--fg3);margin-bottom:18px;line-height:1.5">
      Choisissez le format selon votre besoin.</p>
    <div id="exp-opts">
      <div class="exp-opt" data-type="backup" onclick="selExp('backup')">
        <div class="exp-ico">ğŸ’¾</div>
        <div>
          <div class="exp-ttl">Sauvegarde complÃ¨te (JSON)</div>
          <div class="exp-desc">Toutes vos donnÃ©es dans un fichier. Importez-le pour reprendre exactement oÃ¹ vous en Ã©tiez.</div>
        </div>
      </div>
      <div class="exp-opt" data-type="csv" onclick="selExp('csv')">
        <div class="exp-ico">ğŸ“Š</div>
        <div>
          <div class="exp-ttl">Export comptabilitÃ© (CSV)</div>
          <div class="exp-desc">Tableau complet pour votre comptable ou liasse fiscale.</div>
        </div>
      </div>

    </div>
    <div id="exp-period" style="display:none;margin-top:16px">
      <div class="fi-row">
        <div class="fg-s" style="margin-bottom:0">
          <label class="fl">PÃ©riode</label>
          <select class="fi" id="ep-per" style="padding:10px 12px">
            <option value="tout">Tout</option><option value="mois">Mois en cours</option>
            <option value="trim1">T1</option><option value="trim2">T2</option>
            <option value="trim3">T3</option><option value="trim4">T4</option>
            <option value="annee">AnnÃ©e</option>
          </select>
        </div>
        <div class="fg-s" style="margin-bottom:0">
          <label class="fl">AnnÃ©e</label>
          <select class="fi" id="ep-yr" style="padding:10px 12px">
            <option value="2026">2026</option><option value="2025">2025</option>
          </select>
        </div>
      </div>
    </div>
  </div>
  <div class="sf">
    <button class="btn btn-gold" onclick="doExport()">Exporter</button>
  </div>
</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SHEET: PROFIL & PARAMÃˆTRES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="overlay" id="sh-profil">
<div class="sheet">
  <div class="drag-pill"></div>
  <div class="sh">
    <div class="sh-title">Profil & ParamÃ¨tres</div>
    <button class="sh-close" onclick="closeSheet('sh-profil')">âœ•</button>
  </div>
  <div class="sb">
    <div class="section-header">IdentitÃ©</div>
    <div class="fi-row">
      <div class="fg-s" style="margin-bottom:0">
        <label class="fl">PrÃ©nom *</label>
        <input type="text" class="fi" id="p-fn" placeholder="Votre prÃ©nom">
      </div>
      <div class="fg-s" style="margin-bottom:0">
        <label class="fl">Nom *</label>
        <input type="text" class="fi" id="p-ln" placeholder="Votre nom">
      </div>
    </div>
    <div class="fi-row" style="margin-top:14px">
      <div class="fg-s" style="margin-bottom:0">
        <label class="fl">CV fiscal</label>
        <select class="fi" id="p-cv">
          <option value="3">3 CV âˆ’</option><option value="4">4 CV</option>
          <option value="5" selected>5 CV</option><option value="6">6 CV</option>
          <option value="7">7 CV +</option>
        </select>
      </div>
      <div class="fg-s" style="margin-bottom:0">
        <label class="fl">Immatriculation</label>
        <input type="text" class="fi" id="p-veh" placeholder="AB-123-CD">
      </div>
    </div>
    <div class="fg-s" style="margin-top:14px">
      <label class="fl">SociÃ©tÃ©</label>
      <input type="text" class="fi" id="p-soc" placeholder="ConformitÃ© du Patrimoine">
    </div>

    <div class="divider"></div>
    <div class="section-header">Calcul automatique â€” OSRM</div>
    <div style="background:var(--em-bg);border:1px solid rgba(77,184,135,.2);border-radius:12px;
      padding:13px 15px;font-size:12.5px;color:var(--emerald);line-height:1.6">
      âœ… <strong>OSRM / OpenStreetMap</strong> â€” ItinÃ©raire routier rÃ©el, 100 % gratuit,
      sans inscription, sans clÃ© API. Actif automatiquement.
    </div>

    <div class="divider"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div class="section-header" style="padding:0">Adresses favorites</div>
      <button class="btn btn-ink btn-sm" style="padding:7px 12px;font-size:12px;border-radius:8px"
        onclick="openAddFav()">+ Ajouter</button>
    </div>
    <div id="fav-list"></div>

    <div class="divider"></div>
    <div class="section-header">SÃ©curitÃ©</div>
    <div id="pin-btn-wrap" style="display:flex;gap:10px;flex-wrap:wrap"></div>

    <div class="divider"></div>
    <div class="section-header">DonnÃ©es</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px">
      <button class="btn btn-ink" style="flex:1;padding:11px;font-size:13px;border-radius:12px"
        onclick="openSheet('sh-export');closeSheet('sh-profil')">ğŸ“¤ Exporter mes donnÃ©es</button>
      <button class="btn btn-ink" style="flex:1;padding:11px;font-size:13px;border-radius:12px"
        onclick="triggerImport()">ğŸ“¥ Importer des donnÃ©es</button>
    </div>

  </div>
  <div class="sf" style="gap:10px">
    <button class="btn btn-gold" onclick="saveProfil()">Sauvegarder le profil</button>
    <button class="btn btn-danger" style="width:100%;padding:12px;border-radius:12px"
      onclick="clearAll()">Effacer toutes les donnÃ©es</button>
  </div>
</div>
</div>

<!-- â•â• ADD FAV SHEET â•â• -->
<div class="overlay" id="sh-fav">
<div class="sheet">
  <div class="drag-pill"></div>
  <div class="sh">
    <div class="sh-title">Ajouter un favori</div>
    <button class="sh-close" onclick="closeSheet('sh-fav')">âœ•</button>
  </div>
  <div class="sb">
    <div class="fg-s">
      <label class="fl">IcÃ´ne</label>
      <div class="emoji-grid" id="fav-emoji-grid">
        <div class="eg-item sel" data-e="ğŸ ">ğŸ <span>Domicile</span></div>
        <div class="eg-item" data-e="ğŸ¢">ğŸ¢<span>Bureau</span></div>
        <div class="eg-item" data-e="ğŸ—ï¸">ğŸ—ï¸<span>Chantier</span></div>
        <div class="eg-item" data-e="ğŸ¦">ğŸ¦<span>Banque</span></div>
        <div class="eg-item" data-e="ğŸ­">ğŸ­<span>Fournisseur</span></div>
        <div class="eg-item" data-e="ğŸ›’">ğŸ›’<span>MatÃ©riaux</span></div>
        <div class="eg-item" data-e="ğŸ“¦">ğŸ“¦<span>EntrepÃ´t</span></div>
        <div class="eg-item" data-e="ğŸ§‘â€ğŸ’¼">ğŸ§‘â€ğŸ’¼<span>Client</span></div>
        <div class="eg-item" data-e="ğŸš‰">ğŸš‰<span>Gare</span></div>
        <div class="eg-item" data-e="â­">â­<span>Autre</span></div>
      </div>
    </div>
    <div class="fg-s">
      <label class="fl">LibellÃ© *</label>
      <input type="text" class="fi" id="fav-label" placeholder="ex : Domicile, SiÃ¨ge socialâ€¦">
    </div>
    <div class="fg-s">
      <label class="fl">Adresse *</label>
      <div class="ac-wrap">
        <input type="text" class="fi" id="fav-addr" placeholder="Tapez ou collez l'adresseâ€¦"
          autocomplete="off" oninput="acSearch('fav-addr','ac-fav-addr','fav')">
        <div class="ac-list" id="ac-fav-addr"></div>
      </div>
    </div>
  </div>
  <div class="sf">
    <button class="btn btn-gold" onclick="saveFav()">Ajouter ce favori</button>
  </div>
</div>
</div>

<div class="toast-wrap" id="toasts"></div>
<div id="print-doc" style="display:none"></div>
<input type="file" id="file-import" accept=".json" style="display:none" onchange="doImport(event)">

<style>
/* Export options styling */
.exp-opt{display:flex;align-items:center;gap:14px;padding:15px 16px;
  background:var(--ink4);border:1.5px solid var(--line2);border-radius:var(--r);
  margin-bottom:10px;cursor:pointer;transition:all .15s}
.exp-opt:active,.exp-opt.sel{border-color:var(--gold);background:var(--gold-bg)}
.exp-ico{font-size:28px;flex-shrink:0;line-height:1}
.exp-ttl{font-size:14px;font-weight:700;color:var(--fg);margin-bottom:3px}
.exp-desc{font-size:12px;color:var(--fg3);line-height:1.4}
/* Remb trip checkboxes */
.rtrip{display:flex;align-items:center;gap:10px;padding:10px 12px;
  border-bottom:1px solid var(--line);cursor:pointer;font-size:12.5px}
.rtrip:last-child{border-bottom:none}
.rtrip input[type=checkbox]{accent-color:var(--gold);width:16px;height:16px;flex-shrink:0}
.rtrip-main{flex:1;line-height:1.4}
.rtrip-amt{font-weight:700;color:var(--gold);font-size:13px}
/* Stat rows */
.stat-r{display:flex;justify-content:space-between;align-items:center;
  padding:11px 0;border-bottom:1px solid var(--line);font-size:13px}
.stat-r:last-child{border-bottom:none}
.stat-l{color:var(--fg3);font-weight:500}
.stat-v{font-weight:700;color:var(--fg)}
/* Fav list item */
.fav-item{display:flex;align-items:center;gap:10px;padding:10px 0;
  border-bottom:1px solid var(--line)}
.fav-item:last-child{border-bottom:none}
/* Versement solde bar */
.sol-bar{background:var(--ink3);border:1px solid var(--line);border-radius:var(--r);
  padding:16px;margin:0 20px 12px}
</style>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BARÃˆME DGFIP 2025 (applicable 2026)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BAR = {
  3:{a:.529,b1:.316,b2:1065,c:.370},
  4:{a:.606,b1:.340,b2:1330,c:.407},
  5:{a:.636,b1:.357,b2:1395,c:.427},
  6:{a:.665,b1:.374,b2:1457,c:.447},
  7:{a:.697,b1:.394,b2:1515,c:.470}
};
const CV_L = {3:'3 CV',4:'4 CV',5:'5 CV',6:'6 CV',7:'7 CV+'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let DB = {profil:{favoris:[]}, trips:[], payments:[]};
function loadDB(){
  try{ const s=localStorage.getItem('kmpro5'); if(s) DB=JSON.parse(s); }catch(e){}
  DB.profil = DB.profil||{favoris:[]};
  DB.profil.favoris = DB.profil.favoris||[];
  DB.trips = DB.trips||[];
  DB.payments = DB.payments||[];
}
function saveDB(){ localStorage.setItem('kmpro5',JSON.stringify(DB)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function indem(kmBase, kmNew, cv){
  const b=BAR[cv]||BAR[5];
  let tot=0, rest=kmNew, cur=kmBase;
  while(rest>0){
    if(cur<5000){ const d=Math.min(rest,5000-cur); tot+=d*b.a; cur+=d; rest-=d; }
    else if(cur<20000){ const d=Math.min(rest,20000-cur); if(cur===5000)tot+=b.b2; tot+=d*b.b1; cur+=d; rest-=d; }
    else{ tot+=rest*b.c; rest=0; }
  }
  return +tot.toFixed(2);
}
function kmYear(assoc, yr, excl){
  return DB.trips.filter(t=>t.assoc===assoc && new Date(t.date).getFullYear()===yr && t.id!==excl)
    .reduce((s,t)=>s+t.kmT,0);
}
function soldeDu(assoc){
  const d=DB.trips.filter(t=>t.assoc===assoc).reduce((s,t)=>s+t.ind,0);
  const p=DB.payments.filter(p=>p.assoc===assoc).reduce((s,p)=>s+p.amt,0);
  return +(d-p).toFixed(2);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROFIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nameOf(assoc){
  if(assoc==='me'){ const p=DB.profil; return p.fn&&p.ln?p.fn+' '+p.ln:'Moi'; }
  return assoc;
}
function loadProfil(){
  const p=DB.profil;
  setVal('p-fn',p.fn||''); setVal('p-ln',p.ln||'');
  setVal('p-cv',p.cv||5); setVal('p-veh',p.veh||'');
  setVal('p-soc',p.soc||'ConformitÃ© du Patrimoine');
  renderFavList(); updateHeader();
}
function saveProfil(){
  DB.profil.fn=getVal('p-fn').trim();
  DB.profil.ln=getVal('p-ln').trim();
  DB.profil.cv=parseInt(getVal('p-cv'));
  DB.profil.veh=getVal('p-veh').trim();
  DB.profil.soc=getVal('p-soc').trim()||'ConformitÃ© du Patrimoine';
  saveDB(); updateHeader(); prefillTrip();
  closeSheet('sh-profil'); toast('Profil sauvegardÃ©','ok');
}
function updateHeader(){
  const p=DB.profil;
  const h=new Date().getHours();
  const sal = h<5?'Bonsoir': h<12?'Bonjour': h<18?'Bonjour':'Bonsoir';
  document.getElementById('greeting').textContent = sal+(p.fn?' '+p.fn:'');
  document.getElementById('greeting-sub').textContent = p.soc||'ConformitÃ© du Patrimoine';
  const av=document.getElementById('avatar');
  av.textContent = p.fn&&p.ln ? p.fn[0]+p.ln[0] : '?';
}
function prefillTrip(){
  const p=DB.profil;
  if(p.cv) setVal('t-cv',p.cv);
  if(p.veh) setVal('t-veh',p.veh);
}
function fillSelect(id, withMe=true){
  const el=document.getElementById(id); if(!el)return;
  const cur=el.value;
  const me = withMe && DB.profil.fn
    ? `<option value="me">${DB.profil.fn} ${DB.profil.ln||''} (moi)</option>` : '';
  el.innerHTML = (id==='t-assoc'||id==='r-assoc'?'<option value="">â€” Choisir â€”</option>':'')
    + me;
  el.value = cur||( id==='t-assoc' && DB.profil.fn ? 'me' : '' );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FAVORIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFavList(){
  const c=document.getElementById('fav-list');
  const favs=DB.profil.favoris||[];
  if(!favs.length){ c.innerHTML='<div style="font-size:12px;color:var(--fg3);padding:4px 0">Aucun favori. Ajoutez vos adresses frÃ©quentes.</div>'; return; }
  c.innerHTML='';
  favs.forEach((f,i)=>{
    const d=document.createElement('div');
    d.className='fav-item';
    d.innerHTML=`<span style="font-size:22px;margin-right:4px">${f.emoji||'â­'}</span><div style="flex:1"><div style="font-size:13px;font-weight:600">${esc(f.label)}</div><div style="font-size:11px;color:var(--fg3);margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:200px">${esc(f.addr)}</div></div>`;
    const b=document.createElement('button');
    b.innerHTML='ğŸ—‘'; b.style.cssText='background:none;border:none;color:var(--ruby);font-size:16px;cursor:pointer;padding:4px 8px;flex-shrink:0';
    b.addEventListener('click',()=>{ DB.profil.favoris.splice(i,1); saveDB(); renderFavList(); renderFavChips(); });
    d.appendChild(b); c.appendChild(d);
  });
}
function renderFavChips(){
  const favs=DB.profil.favoris||[];
  ['dep','arr'].forEach(f=>{
    const wrap=document.getElementById('favs-'+f);
    wrap.innerHTML='';
    favs.forEach(fav=>{
      const el=document.createElement('div');
      el.className='fav-chip';
      el.innerHTML=(fav.emoji||'â­')+' '+esc(fav.label);
      el.addEventListener('click',()=>applyFav(f,fav.addr));
      wrap.appendChild(el);
    });
  });
}
function openAddFav(){
  setVal('fav-label',''); setVal('fav-addr','');
  // Reset emoji selection
  document.querySelectorAll('.eg-item').forEach((el,i)=>el.classList.toggle('sel',i===0));
  openSheet('sh-fav');
  // Emoji click handlers
  document.querySelectorAll('.eg-item').forEach(el=>{
    el.onclick=()=>{
      document.querySelectorAll('.eg-item').forEach(x=>x.classList.remove('sel'));
      el.classList.add('sel');
      // Auto-fill label si vide
      const lbl=document.getElementById('fav-label');
      if(!lbl.value.trim()) lbl.value=el.querySelector('span').textContent;
    };
  });
}
function saveFav(){
  const label=getVal('fav-label').trim(), addr=getVal('fav-addr').trim();
  if(!label||!addr){ toast('Remplissez le libellÃ© et l\'adresse','err'); return; }
  const sel=document.querySelector('.eg-item.sel');
  const emoji=sel?sel.dataset.e:'â­';
  DB.profil.favoris.push({label,addr,emoji});
  saveDB(); renderFavList(); renderFavChips();
  closeSheet('sh-fav'); toast('Favori ajoutÃ© âœ“','ok');
}
async function applyFav(field, addr){
  const inputId = field==='dep'?'t-dep':'t-arr';
  document.getElementById(inputId).value = addr;
  document.getElementById('ac-'+(field==='dep'?'dep':'arr')).classList.remove('show');
  // Geocode silently
  try{
    const r=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(addr)}&format=json&limit=1&countrycodes=fr`);
    const d=await r.json();
    if(d[0]) coords[field]={lat:+d[0].lat,lon:+d[0].lon};
    if(coords.dep&&coords.arr) calcRoute();
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTOCOMPLETE NOMINATIM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const coords = {dep:null, arr:null, fav:null};
const acCache = {};
let acTimers = {};

async function acSearch(inputId, listId, field){
  const val = document.getElementById(inputId).value.trim();
  const list = document.getElementById(listId);
  clearTimeout(acTimers[field]);
  if(val.length<3){ list.classList.remove('show'); return; }

  list.innerHTML='<div class="ac-loader">Rechercheâ€¦</div>';
  list.classList.add('show');

  acTimers[field] = setTimeout(async()=>{
    if(acCache[val]){ renderAcList(list, acCache[val], inputId, listId, field); return; }
    try{
      const r = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(val)}&format=json&addressdetails=1&limit=6&countrycodes=fr&accept-language=fr`,
        {headers:{'Accept-Language':'fr'}});
      const data = await r.json();
      acCache[val] = data;
      renderAcList(list, data, inputId, listId, field);
    }catch(e){
      list.innerHTML='<div class="ac-loader">Erreur rÃ©seau â€” vÃ©rifiez votre connexion</div>';
    }
  }, 420);
}

function renderAcList(list, data, inputId, listId, field){
  if(!data.length){ list.innerHTML='<div class="ac-loader">Aucun rÃ©sultat</div>'; return; }
  list.innerHTML='';
  data.forEach((item,i)=>{
    const a=item.address||{};
    const road = a.road||a.pedestrian||a.path||'';
    const num = a.house_number||'';
    const city = a.city||a.town||a.village||a.municipality||'';
    const pc = a.postcode||'';
    const mainLabel = (num?num+' ':'')+road || item.display_name.split(',')[0];
    const sub = [pc,city].filter(Boolean).join(' ') || item.display_name.split(',').slice(1,3).join(',').trim();
    const el = document.createElement('div');
    el.className='ac-item';
    el.innerHTML=`<div class="ac-main">${esc(mainLabel)}</div><div class="ac-sub">${esc(sub)}</div>`;
    el.addEventListener('click',()=>{
      document.getElementById(inputId).value = item.display_name;
      list.classList.remove('show');
      coords[field] = {lat:+item.lat, lon:+item.lon};
      if(coords.dep&&coords.arr) calcRoute();
    });
    list.appendChild(el);
  });
}

document.addEventListener('click', e=>{
  if(!e.target.closest('.ac-wrap')) document.querySelectorAll('.ac-list').forEach(l=>l.classList.remove('show'));
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function useGPS(field){
  if(!navigator.geolocation){ toast('GPS non disponible','err'); return; }
  const btn=document.getElementById('gps-'+field);
  btn.classList.add('loading'); btn.style.pointerEvents='none';
  navigator.geolocation.getCurrentPosition(async pos=>{
    const {latitude:lat, longitude:lon} = pos.coords;
    try{
      const r=await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=fr`);
      const d=await r.json();
      const addr = d.display_name||`${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      document.getElementById(field==='dep'?'t-dep':'t-arr').value = addr;
      coords[field]={lat,lon};
      if(coords.dep&&coords.arr) calcRoute();
      toast('Position dÃ©tectÃ©e âœ“','ok');
    }catch(e){
      document.getElementById(field==='dep'?'t-dep':'t-arr').value=`${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      coords[field]={lat,lon};
    }
    btn.classList.remove('loading'); btn.style.pointerEvents='';
  }, err=>{
    btn.classList.remove('loading'); btn.style.pointerEvents='';
    const m={1:'AccÃ¨s GPS refusÃ© â€” activez la localisation',2:'Position indisponible',3:'DÃ©lai dÃ©passÃ©'};
    toast(m[err.code]||'Erreur GPS','err');
  },{enableHighAccuracy:true,timeout:12000,maximumAge:0});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CARTE LEAFLET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let lmap=null, rlayer=null;
function showMap(cA, cB, routePts){
  const wrap=document.getElementById('map-wrap');
  wrap.classList.add('show');
  if(!lmap){
    lmap=L.map('trip-map',{zoomControl:false,attributionControl:false});
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(lmap);
    L.control.zoom({position:'bottomright'}).addTo(lmap);
    L.control.attribution({position:'bottomleft',prefix:'Â© OSM'}).addTo(lmap);
  }else{
    lmap.eachLayer(l=>{ if(l instanceof L.CircleMarker||l instanceof L.Polyline) lmap.removeLayer(l); });
  }
  L.circleMarker([cA.lat,cA.lon],{radius:9,fillColor:'#c8a96e',color:'#fff',weight:2.5,fillOpacity:1}).bindPopup('ğŸ“ DÃ©part').addTo(lmap);
  L.circleMarker([cB.lat,cB.lon],{radius:9,fillColor:'#4db887',color:'#fff',weight:2.5,fillOpacity:1}).bindPopup('ğŸ ArrivÃ©e').addTo(lmap);
  if(routePts&&routePts.length>1){
    rlayer=L.polyline(routePts,{color:'#c8a96e',weight:4,opacity:.9}).addTo(lmap);
    lmap.fitBounds(rlayer.getBounds(),{padding:[28,28]});
  }else{
    rlayer=L.polyline([[cA.lat,cA.lon],[cB.lat,cB.lon]],{color:'#c8a96e',weight:3,opacity:.65,dashArray:'8,5'}).addTo(lmap);
    lmap.fitBounds(rlayer.getBounds(),{padding:[28,28]});
  }
  setTimeout(()=>lmap.invalidateSize(),120);
}
function hideMap(){
  document.getElementById('map-wrap').classList.remove('show');
  if(lmap){lmap.remove();lmap=null;rlayer=null;}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCUL ROUTE OSRM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function calcRoute(){
  const dep=getVal('t-dep').trim(), arr=getVal('t-arr').trim();
  if(!dep||!arr){ toast('Renseignez dÃ©part et arrivÃ©e','err'); return; }
  const box=document.getElementById('calc-box');
  box.className='calc-box loading'; box.textContent='Calcul de l\'itinÃ©raireâ€¦';

  // GÃ©ocoder si pas de coords
  for(const [f,val] of [['dep',dep],['arr',arr]]){
    if(!coords[f]){
      try{
        const r=await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(val)}&format=json&limit=1&countrycodes=fr`);
        const d=await r.json();
        if(d[0]) coords[f]={lat:+d[0].lat,lon:+d[0].lon};
      }catch(e){}
    }
  }
  if(!coords.dep||!coords.arr){ btn.disabled=false; box.className='calc-box'; box.textContent='Adresses non trouvÃ©es â€” saisissez les km manuellement'; return; }

  try{
    const url=`https://router.project-osrm.org/route/v1/driving/${coords.dep.lon},${coords.dep.lat};${coords.arr.lon},${coords.arr.lat}?overview=full&geometries=geojson`;
    const r=await fetch(url);
    if(!r.ok) throw new Error('osrm '+r.status);
    const data=await r.json();
    if(data.code!=='Ok') throw new Error('no route');
    const km=Math.round(data.routes[0].distance/1000);
    const min=Math.round(data.routes[0].duration/60);
    setVal('t-km',km);
    box.className='calc-box';
    box.innerHTML=`<strong style="color:var(--gold3)">${km} km</strong> Â· ~${min} min Â· itinÃ©raire routier rÃ©el`;
    calcPreview();
    const pts = data.routes[0].geometry?.coordinates?.map(c=>[c[1],c[0]])||null;
    showMap(coords.dep,coords.arr,pts);
    toast(`${km} km calculÃ©s âœ“`,'ok');
  }catch(e){
    // Fallback vol d'oiseau Ã—1.3
    const R=6371,dLat=(coords.arr.lat-coords.dep.lat)*Math.PI/180,dLon=(coords.arr.lon-coords.dep.lon)*Math.PI/180;
    const a=Math.sin(dLat/2)**2+Math.cos(coords.dep.lat*Math.PI/180)*Math.cos(coords.arr.lat*Math.PI/180)*Math.sin(dLon/2)**2;
    const km=Math.round(R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a))*1.3);
    setVal('t-km',km);
    box.className='calc-box';
    box.innerHTML=`âš ï¸ <strong>${km} km</strong> estimÃ©s (OSRM indisponible â€” vÃ©rifiez)`;
    calcPreview();
    showMap(coords.dep,coords.arr,null);
    toast('Estimation : '+km+' km (vÃ©rifiez)','tip');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREVIEW INDEMNITÃ‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcPreview(){
  const km=parseFloat(getVal('t-km'))||0;
  const ar=parseInt(getVal('t-ar'))||1;
  const cv=parseInt(getVal('t-cv'))||5;
  const assoc=getVal('t-assoc');
  const date=getVal('t-date');
  const box=document.getElementById('calc-box');
  if(km===0){ if(!box.textContent.includes('km')) box.textContent='Saisissez les km pour voir l\'indemnitÃ© calculÃ©e'; return; }
  const kmT=km*ar;
  const yr=date?new Date(date).getFullYear():new Date().getFullYear();
  const base=kmYear(assoc,yr,editId);
  const ind=indem(base,kmT,cv);
  const taux=(ind/kmT).toFixed(4);
  box.className='calc-box';
  box.innerHTML=`${kmT} km${ar===2?' (Ã—2 AR)':''} Â· ${taux} â‚¬/km Â· Cumul ${yr} : ${base+kmT} km<span class="calc-big">${ind.toFixed(2)} â‚¬</span>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRAJET CRUD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let editId=null;
function openNewTrajet(){
  editId=null;
  document.getElementById('sh-trajet-ttl').textContent='Nouveau trajet';
  setVal('t-date',new Date().toISOString().slice(0,10));
  ['t-dep','t-arr','t-motif','t-notes'].forEach(id=>setVal(id,''));
  setVal('t-km',''); setVal('t-ar','2');
  fillSelect('t-assoc');
  prefillTrip();
  renderFavChips();
  document.getElementById('calc-box').className='calc-box';
  document.getElementById('calc-box').textContent='Saisissez les km pour voir l\'indemnitÃ© calculÃ©e';
  hideMap();
  coords.dep=null; coords.arr=null;
  openSheet('sh-trajet');
}
function saveTrajet(){
  const assoc=getVal('t-assoc'), date=getVal('t-date');
  const dep=getVal('t-dep').trim(), arr=getVal('t-arr').trim();
  const motif=getVal('t-motif').trim();
  const km=parseFloat(getVal('t-km'))||0;
  const ar=parseInt(getVal('t-ar'))||1;
  const cv=parseInt(getVal('t-cv'))||5;
  const veh=getVal('t-veh').trim(), notes=getVal('t-notes').trim();
  // Validation visuelle
  const errs = [];
  const checkField = (id, val, label) => {
    const el = document.getElementById(id);
    if(!val){ el.classList.add('field-err'); errs.push({el,label}); setTimeout(()=>el.classList.remove('field-err'),1500); }
    else el.classList.remove('field-err');
  };
  checkField('t-assoc', assoc, 'AssociÃ©');
  checkField('t-date', date, 'Date');
  checkField('t-dep', dep, 'DÃ©part');
  checkField('t-arr', arr, 'ArrivÃ©e');
  checkField('t-motif', motif, 'Motif');
  checkField('t-km', km>0?'ok':'', 'KilomÃ¨tres');
  if(errs.length){
    const msg = errs.length===1 ? `Champ manquant : ${errs[0].label}` : `${errs.length} champs manquants â€” vÃ©rifiez les champs surlignÃ©s`;
    toast(msg,'err');
    errs[0].el.scrollIntoView({behavior:'smooth',block:'center'});
    return;
  }
  const yr=new Date(date).getFullYear(), kmT=km*ar;
  const base=kmYear(assoc,yr,editId);
  const ind=indem(base,kmT,cv);
  if(editId){
    const i=DB.trips.findIndex(t=>t.id===editId);
    if(i>-1) DB.trips[i]={...DB.trips[i],assoc,date,dep,arr,motif,km,ar,kmT,cv,veh,notes,ind};
    toast('Trajet modifiÃ© âœ“','ok'); editId=null;
  }else{
    DB.trips.push({id:uid(),assoc,date,dep,arr,motif,km,ar,kmT,cv,veh,notes,ind,status:'wait',paid:0});
    toast('Trajet enregistrÃ© âœ“','ok');
  }
  saveDB(); closeSheet('sh-trajet'); renderAll();
}
function openDetail(id){
  const t=DB.trips.find(x=>x.id===id); if(!t)return;
  const reste=+(t.ind-(t.paid||0)).toFixed(2);
  document.getElementById('detail-body').innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px">
      <div style="flex:1;min-width:0">
        <div style="font-size:16px;font-weight:700;margin-bottom:5px;overflow:hidden;text-overflow:ellipsis">${esc(t.dep.split(',')[0])}</div>
        <div style="font-size:11px;color:var(--fg3);margin-bottom:5px">â†“ vers</div>
        <div style="font-size:16px;font-weight:700;overflow:hidden;text-overflow:ellipsis">${esc(t.arr.split(',')[0])}</div>
      </div>
      <div style="text-align:right;margin-left:16px;flex-shrink:0">
        <div class="serif" style="font-size:32px;font-weight:600;color:var(--gold)">${t.ind.toFixed(2)} â‚¬</div>
        <div style="margin-top:4px">${badge(t.status)}</div>
      </div>
    </div>
    <div style="background:var(--ink3);border:1px solid var(--line);border-radius:var(--r);padding:4px 16px">
      ${dr('Date',fmtDate(t.date))}${dr('AssociÃ©',nameOf(t.assoc))}${dr('Motif',t.motif)}
      ${dr('Km',t.km+' km Ã— '+t.ar+(t.ar===2?' (AR)':'')+' = '+t.kmT+' km')}
      ${dr('Puissance',CV_L[t.cv])}${t.veh?dr('VÃ©hicule',t.veh):''}
      ${t.notes?dr('Notes',t.notes):''}
      ${dr('RemboursÃ©',(t.paid||0).toFixed(2)+' â‚¬')}
      ${dr('Reste dÃ»',`<span class="${reste>0?'ruby':'emerald'}">${reste.toFixed(2)} â‚¬</span>`)}
    </div>`;
  const foot=document.getElementById('detail-foot');
  foot.innerHTML='<div style="display:flex;gap:10px"><button class="btn btn-ink" id="d-edit" style="flex:1;padding:12px">âœï¸ Modifier</button><button class="btn btn-danger" id="d-del" style="flex:1;padding:12px;border-radius:12px">ğŸ—‘ Supprimer</button></div>';
  foot.querySelector('#d-edit').addEventListener('click',()=>editTrip(id));
  foot.querySelector('#d-del').addEventListener('click',()=>delTrip(id));
  openSheet('sh-detail');
}
function editTrip(id){
  const t=DB.trips.find(x=>x.id===id); if(!t)return;
  editId=id; closeSheet('sh-detail');
  setTimeout(()=>{
    document.getElementById('sh-trajet-ttl').textContent='Modifier le trajet';
    fillSelect('t-assoc'); renderFavChips();
    setVal('t-assoc',t.assoc); setVal('t-date',t.date);
    setVal('t-dep',t.dep); setVal('t-arr',t.arr);
    setVal('t-motif',t.motif); setVal('t-km',t.km);
    setVal('t-ar',t.ar); setVal('t-cv',t.cv);
    setVal('t-veh',t.veh||''); setVal('t-notes',t.notes||'');
    coords.dep=null; coords.arr=null;
    hideMap(); calcPreview();
    openSheet('sh-trajet');
  },320);
}
function delTrip(id){
  if(!confirm('Supprimer ce trajet ?')) return;
  DB.trips=DB.trips.filter(t=>t.id!==id);
  saveDB(); closeSheet('sh-detail'); renderAll();
  toast('Trajet supprimÃ©','tip');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  renderKPIs(); renderHome(); renderTrips(); renderRemb(); renderDot(); updateHeader();
}
function renderKPIs(){
  const yr=new Date().getFullYear();
  const kmY=DB.trips.filter(t=>new Date(t.date).getFullYear()===yr).reduce((s,t)=>s+t.kmT,0);
  const totDu=+DB.trips.reduce((s,t)=>s+t.ind,0).toFixed(2);
  const totPaid=+DB.payments.reduce((s,p)=>s+p.amt,0).toFixed(2);
  const sol=+(totDu-totPaid).toFixed(2);
  document.getElementById('kpi-home').innerHTML=`
    <div class="kpi c-gold"><div class="kpi-l">Km ${yr}</div><div class="kpi-v">${kmY.toLocaleString('fr-FR')}<span class="kpi-u"> km</span></div><div class="kpi-s">${DB.trips.length} trajet(s)</div></div>
    <div class="kpi ${sol>0?'c-ruby':'c-em'}"><div class="kpi-l">Solde dÃ»</div><div class="kpi-v">${Math.abs(sol).toLocaleString('fr-FR',{minimumFractionDigits:2})}<span class="kpi-u"> â‚¬</span></div><div class="kpi-s">${sol>0?'Ã€ percevoir':'âœ“ Ã€ jour'}</div></div>
    <div class="kpi c-em"><div class="kpi-l">Total dÃ»</div><div class="kpi-v">${totDu.toLocaleString('fr-FR',{minimumFractionDigits:2})}<span class="kpi-u"> â‚¬</span></div><div class="kpi-s">BarÃ¨me 2025</div></div>
    <div class="kpi c-sap"><div class="kpi-l">RemboursÃ©</div><div class="kpi-v">${totPaid.toLocaleString('fr-FR',{minimumFractionDigits:2})}<span class="kpi-u"> â‚¬</span></div><div class="kpi-s">${DB.payments.length} versement(s)</div></div>`;
}
function renderHome(){
  const c=document.getElementById('home-list');
  const list=[...DB.trips].sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,5);
  if(!list.length){ c.innerHTML=`<div class="empty"><div class="empty-ico">ğŸš—</div><h3>Aucun trajet</h3><p>Appuyez sur + pour enregistrer votre premier dÃ©placement professionnel</p></div>`; return; }
  c.innerHTML='';
  list.forEach(t=>{ const el=mkTripCard(t); c.appendChild(el); });
}
function renderTrips(){
  // Segment mois
  const mSet=new Set();
  const now=new Date();
  for(let i=0;i<6;i++){ const d=new Date(now.getFullYear(),now.getMonth()-i,1); mSet.add(`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`); }
  DB.trips.forEach(t=>mSet.add(t.date.slice(0,7)));
  const months=[...mSet].sort().reverse().slice(0,6);
  if(!activeMois||!months.includes(activeMois)) activeMois=null;
  const ML={'01':'Jan','02':'FÃ©v','03':'Mar','04':'Avr','05':'Mai','06':'Jun','07':'Jul','08':'AoÃ»','09':'Sep','10':'Oct','11':'Nov','12':'DÃ©c'};
  const seg=document.getElementById('seg-mois');
  seg.innerHTML=`<button class="seg-b ${!activeMois?'active':''}" data-m="">Tout</button>`
    +months.map(m=>{const[y,mo]=m.split('-');return`<button class="seg-b ${activeMois===m?'active':''}" data-m="${m}">${ML[mo]} ${y.slice(2)}</button>`;}).join('');
  seg.querySelectorAll('.seg-b').forEach(b=>b.addEventListener('click',()=>{activeMois=b.dataset.m||null;renderTrips();}));

  let trips=[...DB.trips].sort((a,b)=>new Date(b.date)-new Date(a.date));
  if(activeMois) trips=trips.filter(t=>t.date.startsWith(activeMois));
  const tkm=trips.reduce((s,t)=>s+t.kmT,0), tind=trips.reduce((s,t)=>s+t.ind,0);
  document.getElementById('trajets-sub').textContent=`${trips.length} trajet(s) Â· ${tkm} km Â· ${tind.toFixed(2)} â‚¬`;
  const list=document.getElementById('trajets-list');
  if(!trips.length){ list.innerHTML=`<div class="empty"><div class="empty-ico">ğŸ—ºï¸</div><h3>Aucun trajet</h3><p>Appuyez sur + pour ajouter un trajet</p></div>`; return; }
  list.innerHTML='';
  trips.forEach(t=>{ const el=mkTripCard(t); list.appendChild(el); });
}
function mkTripCard(t){
  const el=document.createElement('div');
  el.className='tc';
  el.innerHTML=`
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div style="flex:1;min-width:0">
        <div class="tc-route">${esc(t.dep.split(',')[0])} â†’ ${esc(t.arr.split(',')[0])}</div>
        <div class="tc-meta">${fmtDate(t.date)} Â· ${t.kmT} km Â· ${nameOf(t.assoc)}</div>
        <div style="margin-top:8px">${badge(t.status)}</div>
      </div>
      <div style="margin-left:14px;text-align:right;flex-shrink:0">
        <div class="tc-amount">${t.ind.toFixed(2)} â‚¬</div>
        ${t.paid>0&&t.status!=='done'?`<div class="tc-paid">+${t.paid.toFixed(2)} â‚¬ reÃ§u</div>`:''}
      </div>
    </div>`;
  el.addEventListener('click',()=>openDetail(t.id));
  return el;
}
function renderRemb(){
  const totDu=+DB.trips.reduce((s,t)=>s+t.ind,0).toFixed(2);
  const totPaid=+DB.payments.reduce((s,p)=>s+p.amt,0).toFixed(2);
  const sol=+(totDu-totPaid).toFixed(2);
  const pct=totDu>0?Math.round(totPaid/totDu*100):100;
  const c=document.getElementById('remb-content');
  let html=`
    <div class="sol-bar">
      <div style="display:flex;justify-content:space-between;margin-bottom:14px">
        <div><div style="font-size:10px;font-weight:700;color:var(--fg3);letter-spacing:.07em;text-transform:uppercase;margin-bottom:6px">Total dÃ»</div>
          <div class="serif" style="font-size:26px;font-weight:600">${totDu.toFixed(2)} â‚¬</div></div>
        <div style="text-align:right"><div style="font-size:10px;font-weight:700;color:var(--fg3);letter-spacing:.07em;text-transform:uppercase;margin-bottom:6px">RemboursÃ©</div>
          <div class="serif" style="font-size:26px;font-weight:600;color:var(--emerald)">${totPaid.toFixed(2)} â‚¬</div></div>
      </div>
      <div class="prog-wrap" style="height:6px"><div class="prog-fill" style="width:${pct}%"></div></div>
      <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:11px;font-weight:600">
        <span style="color:var(--fg3)">${pct}% remboursÃ©</span>
        <span style="color:${sol>0?'var(--ruby)':'var(--emerald)'}">Solde : ${sol.toFixed(2)} â‚¬</span>
      </div>
    </div>
    <div style="padding:0 20px 16px">
      <button class="btn btn-gold" onclick="openRembSheet()">Enregistrer un versement</button>
    </div>`;
  if(!DB.payments.length){
    html+=`<div class="empty"><div class="empty-ico">ğŸ’¸</div><h3>Aucun versement</h3><p>Enregistrez vos remboursements progressifs ici</p></div>`;
  }else{
    html+=`<div style="padding:0 20px 8px"><div style="font-size:11px;font-weight:700;color:var(--fg3);letter-spacing:.07em;text-transform:uppercase">Historique</div></div>`;
    html+=[...DB.payments].sort((a,b)=>new Date(b.date)-new Date(a.date)).map(p=>`
      <div class="remb-card">
        <div class="remb-top">
          <div><div style="font-size:14px;font-weight:700">${nameOf(p.assoc)}</div>
            <div style="font-size:11.5px;color:var(--fg3);margin-top:3px">${fmtDate(p.date)} Â· ${p.mode}${p.ref?' Â· '+esc(p.ref):''}</div>
          </div>
          <div class="rh-amount">+${p.amt.toFixed(2)} â‚¬</div>
        </div>
      </div>`).join('');
  }
  c.innerHTML=html;
}
function renderDot(){
  const n=DB.trips.filter(t=>t.status==='wait').length;
  const d=document.getElementById('dot-trajets');
  d.style.display=n>0?'block':'none';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VERSEMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openRembSheet(){
  fillSelect('r-assoc');
  setVal('r-date',new Date().toISOString().slice(0,10));
  setVal('r-amt',''); setVal('r-ref','');
  const amtEl=document.getElementById('r-amt');
  if(amtEl) amtEl._manual=false;
  rembPreview();
  openSheet('sh-remb');
}
function rembPreview(){
  const assoc=getVal('r-assoc'), amt=parseFloat(getVal('r-amt'))||0;
  const box=document.getElementById('remb-prev');
  if(!assoc){ box.textContent='SÃ©lectionnez un associÃ©'; renderRembTrips(''); return; }
  const sol=soldeDu(assoc);
  box.innerHTML=`Solde dÃ» : <strong style="color:var(--gold2)">${sol.toFixed(2)} â‚¬</strong> Â· Vous versez : <strong style="color:var(--emerald)">${amt.toFixed(2)} â‚¬</strong> Â· Restera : <strong>${Math.max(0,sol-amt).toFixed(2)} â‚¬</strong>`;
  renderRembTrips(assoc);
}
function renderRembTrips(assoc){
  const wrap=document.getElementById('remb-trips');
  const trips=DB.trips.filter(t=>(!assoc||t.assoc===assoc)&&t.status!=='done').sort((a,b)=>new Date(a.date)-new Date(b.date));
  if(!trips.length){ wrap.innerHTML='<div style="padding:12px;font-size:12px;color:var(--fg3);text-align:center">Aucun trajet en attente</div>'; return; }
  wrap.innerHTML='';
  // Header "Tout sÃ©lectionner"
  const hdr=document.createElement('div');
  hdr.style.cssText='padding:8px 12px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px;cursor:pointer';
  hdr.innerHTML=`<input type="checkbox" id="rt-all" style="accent-color:var(--gold);width:16px;height:16px">
    <label for="rt-all" style="font-size:12px;font-weight:700;color:var(--fg2);cursor:pointer">Tout sÃ©lectionner</label>
    <span style="margin-left:auto;font-size:11px;color:var(--fg3)" id="rt-total-lbl"></span>`;
  wrap.appendChild(hdr);
  
  trips.forEach(t=>{
    const reste=+(t.ind-(t.paid||0)).toFixed(2);
    const d=document.createElement('div');
    d.className='rtrip';
    d.dataset.reste=reste;
    d.dataset.id=t.id;
    d.innerHTML=`<input type="checkbox" name="rt" value="${t.id}" style="accent-color:var(--gold);width:16px;height:16px;flex-shrink:0">
      <div class="rtrip-main" style="flex:1"><strong>${fmtDate(t.date)}</strong> Â· <span style="color:var(--fg3)">${esc(t.dep.split(',')[0])} â†’ ${esc(t.arr.split(',')[0])}</span></div>
      <span class="rtrip-amt">${reste.toFixed(2)} â‚¬</span>`;
    wrap.appendChild(d);
  });
  
  // Checkbox event : maj montant auto
  function updateTotal(){
    const checked=[...document.querySelectorAll('[name="rt"]:checked')];
    const total=checked.reduce((s,el)=>s+parseFloat(el.closest('.rtrip')?.dataset.reste||0),0);
    const n=checked.length;
    document.getElementById('rt-total-lbl').textContent = n>0 ? `${n} trajet(s) Â· ${total.toFixed(2)} â‚¬` : '';
    // Mettre Ã  jour montant si c'Ã©tait auto (pas modifiÃ© manuellement)
    const amtEl=document.getElementById('r-amt');
    if(n>0 && (!amtEl._manual || amtEl._manual===false)){
      amtEl.value=total.toFixed(2);
      amtEl._manual=false;
    } else if(n===0){
      amtEl.value=''; amtEl._manual=false;
    }
    // Mettre Ã  jour le select-all
    const allCbs=document.querySelectorAll('[name="rt"]');
    const allAll=document.getElementById('rt-all');
    if(allAll) allAll.checked = n>0 && n===allCbs.length;
    rembPreview();
  }
  
  // SÃ©lection sur clic partout dans la ligne (pas juste la checkbox)
  wrap.querySelectorAll('.rtrip').forEach(row=>{
    row.addEventListener('click', e=>{
      if(e.target.tagName==='INPUT') return; // la checkbox gÃ¨re elle-mÃªme
      const cb=row.querySelector('input[type="checkbox"]');
      cb.checked=!cb.checked;
      updateTotal();
    });
    row.querySelector('input').addEventListener('change', updateTotal);
  });
  
  // Select all
  document.getElementById('rt-all')?.addEventListener('change', e=>{
    document.querySelectorAll('[name="rt"]').forEach(cb=>cb.checked=e.target.checked);
    updateTotal();
  });
}
function saveRemb(){
  const assoc=getVal('r-assoc'), date=getVal('r-date');
  const amt=parseFloat(getVal('r-amt')), mode=getVal('r-mode'), ref=getVal('r-ref').trim();
  if(!assoc||!date||!amt||amt<=0) return toast('Champs obligatoires manquants','err');
  const tripIds=[...document.querySelectorAll('[name="rt"]:checked')].map(e=>e.value);
  DB.payments.push({id:uid(),assoc,date,amt,mode,ref,tripIds,at:new Date().toISOString()});
  
  const targets = tripIds.length
    ? tripIds.map(id=>DB.trips.find(t=>t.id===id)).filter(Boolean)
    : DB.trips.filter(t=>t.assoc===assoc&&t.status!=='done').sort((a,b)=>new Date(a.date)-new Date(b.date));
  
  if(!targets.length){ saveDB(); closeSheet('sh-remb'); renderAll(); toast(`${amt.toFixed(2)} â‚¬ enregistrÃ© âœ“`,'ok'); return; }
  
  // RÃ©partition PROPORTIONNELLE au solde restant de chaque trajet
  const restants = targets.map(t=>+(t.ind-(t.paid||0)).toFixed(2));
  const totalRestant = restants.reduce((s,v)=>s+v, 0);
  
  if(totalRestant <= 0){ saveDB(); closeSheet('sh-remb'); renderAll(); toast(`${amt.toFixed(2)} â‚¬ enregistrÃ© âœ“`,'ok'); return; }
  
  let distributed = 0;
  targets.forEach((t, i) => {
    // Part proportionnelle : (reste_ce_trajet / total_restant) * montant_versÃ©
    const ratio = restants[i] / totalRestant;
    let part = +(amt * ratio).toFixed(2);
    // Dernier trajet : prend le reste exact pour Ã©viter les arrondis
    if(i === targets.length - 1) part = +(amt - distributed).toFixed(2);
    const pay = Math.min(restants[i], Math.max(0, part));
    t.paid = +((t.paid||0) + pay).toFixed(2);
    distributed = +(distributed + pay).toFixed(2);
    t.status = t.paid >= t.ind - 0.01 ? 'done' : t.paid > 0 ? 'part' : 'wait';
  });
  
  saveDB(); closeSheet('sh-remb'); renderAll();
  toast(`${amt.toFixed(2)} â‚¬ rÃ©partis sur ${targets.length} trajet(s) âœ“`,'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATISTIQUES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let cKm=null, cInd=null;
let activeMois=null;
function renderStats(){
  const yr=parseInt(getVal('stats-year'))||2026;
  const now=new Date(), maxM= yr===now.getFullYear() ? now.getMonth() : 11;
  const ML=['Jan','FÃ©v','Mar','Avr','Mai','Jun','Jul','AoÃ»','Sep','Oct','Nov','DÃ©c'];
  const kmM=new Array(12).fill(0), indM=new Array(12).fill(0), nM=new Array(12).fill(0);
  DB.trips.filter(t=>new Date(t.date).getFullYear()===yr).forEach(t=>{
    const m=new Date(t.date).getMonth(); kmM[m]+=t.kmT; indM[m]+=t.ind; nM[m]++;
  });
  const labels=ML.slice(0,maxM+1), kmD=kmM.slice(0,maxM+1), indD=indM.slice(0,maxM+1).map(v=>+v.toFixed(2));
  const chartDef = (type,data,color,unit,isRerender)=>({
    type, data:{labels,datasets:[{data,backgroundColor:type==='bar'?color+'99':color+'22',borderColor:color,borderWidth:2,borderRadius:type==='bar'?6:0,fill:type==='line',tension:.35,pointBackgroundColor:color,pointRadius:4}]},
    options:{responsive:true,maintainAspectRatio:false,
      animation:{duration:isRerender?0:500},  // Pas d'animation au re-render = pas de grossissement
      plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`${ctx.parsed.y} ${unit}`}}},
      scales:{x:{grid:{color:'rgba(255,255,255,.04)'},ticks:{color:'#4a5260',font:{size:10,family:'Plus Jakarta Sans'}}},
              y:{grid:{color:'rgba(255,255,255,.04)'},ticks:{color:'#4a5260',font:{size:10,family:'Plus Jakarta Sans'}},beginAtZero:true}}}
  });
  const isRerender = !!(cKm||cInd);
  if(cKm){cKm.destroy(); cKm=null;} 
  if(cInd){cInd.destroy(); cInd=null;}
  // RecrÃ©er les canvas pour Ã©viter le bug de taille rÃ©siduelle
  const boxKm=document.querySelector('#c-km').parentElement;
  const boxInd=document.querySelector('#c-ind').parentElement;
  boxKm.innerHTML='<canvas id="c-km"></canvas>';
  boxInd.innerHTML='<canvas id="c-ind"></canvas>';
  cKm=new Chart(document.getElementById('c-km'),chartDef('bar',kmD,'#c8a96e','km',isRerender));
  cInd=new Chart(document.getElementById('c-ind'),chartDef('line',indD,'#4db887','â‚¬',isRerender));

  const totKm=kmM.reduce((s,v)=>s+v,0), totInd=+indM.reduce((s,v)=>s+v,0).toFixed(2);
  const totPaid=+DB.payments.filter(p=>new Date(p.date).getFullYear()===yr).reduce((s,p)=>s+p.amt,0).toFixed(2);
  const nb=DB.trips.filter(t=>new Date(t.date).getFullYear()===yr).length;
  const actif=kmM.filter(v=>v>0).length, moy=actif>0?Math.round(totKm/actif):0;
  document.getElementById('stats-recap').innerHTML=`
    ${sr('Km totaux',totKm.toLocaleString('fr-FR')+' km')}
    ${sr('IndemnitÃ©s dues','<span class="gold">'+totInd.toFixed(2)+' â‚¬</span>')}
    ${sr('RemboursÃ©','<span class="emerald">'+totPaid.toFixed(2)+' â‚¬</span>')}
    ${sr('Solde restant','<span class="'+(totInd-totPaid>0?'ruby':'emerald')+'">'+(totInd-totPaid).toFixed(2)+' â‚¬</span>')}
    ${sr('Nb trajets',nb)}
    ${sr('Moy km/mois actif',moy+' km')}`;

  const freq={};
  DB.trips.filter(t=>new Date(t.date).getFullYear()===yr).forEach(t=>{
    const k=`${t.dep.split(',')[0].trim()} â†’ ${t.arr.split(',')[0].trim()}`;
    freq[k]=freq[k]||{n:0,km:0,ind:0};
    freq[k].n++; freq[k].km+=t.kmT; freq[k].ind+=t.ind;
  });
  const top=Object.entries(freq).sort((a,b)=>b[1].n-a[1].n).slice(0,5);
  document.getElementById('stats-freq').innerHTML = top.length
    ? top.map(([r,d])=>sr(esc(r),`<span style="color:var(--fg3);font-size:11px">${d.n}Ã— Â· ${d.km} km Â· ${d.ind.toFixed(2)} â‚¬</span>`)).join('')
    : '<div style="font-size:12px;color:var(--fg3);padding:12px 0">Aucun trajet cette annÃ©e</div>';
  document.getElementById('stats-sub').textContent=`${yr} Â· ${nb} trajet(s) Â· ${totKm} km`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RAPPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genReport(){
  const per=getVal('rap-per'), yr=parseInt(getVal('rap-yr'));
  let mD=1,mF=12;
  if(per==='mois'){const n=new Date();mD=mF=n.getMonth()+1;}
  if(per==='trim1'){mD=1;mF=3;} if(per==='trim2'){mD=4;mF=6;}
  if(per==='trim3'){mD=7;mF=9;} if(per==='trim4'){mD=10;mF=12;}
  const trips=DB.trips.filter(t=>{const d=new Date(t.date);return d.getFullYear()===yr&&d.getMonth()+1>=mD&&d.getMonth()+1<=mF;}).sort((a,b)=>new Date(a.date)-new Date(b.date));
  const pL={mois:'Mois en cours',trim1:`T1 ${yr}`,trim2:`T2 ${yr}`,trim3:`T3 ${yr}`,trim4:`T4 ${yr}`,annee:`AnnÃ©e ${yr}`}[per];
  const p=DB.profil;
  const totKm=trips.reduce((s,t)=>s+t.kmT,0);
  const totInd=+trips.reduce((s,t)=>s+t.ind,0).toFixed(2);
  const totPaid=+trips.reduce((s,t)=>s+(t.paid||0),0).toFixed(2);
  const totReste=+(totInd-totPaid).toFixed(2);
  const out=document.getElementById('report-out');
  if(!trips.length){
    out.innerHTML=`<div class="empty"><div class="empty-ico">ğŸ“­</div><h3>Aucun trajet</h3><p>Aucun trajet pour cette pÃ©riode</p></div>`;
    return;
  }

  // â”€â”€ En-tÃªte professionnel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let html=`
  <div style="margin:0 20px 16px;background:var(--ink3);border:1px solid var(--line);border-radius:var(--r);overflow:hidden">
    <div style="background:linear-gradient(135deg,#1a1410,#2a1f0e);padding:20px 20px 18px;border-bottom:1px solid var(--gold-ring)">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px">
        <div>
          <div class="serif" style="font-size:26px;font-weight:600;color:var(--gold3);line-height:1;margin-bottom:6px">Note de frais kilomÃ©triques</div>
          <div style="font-size:12px;color:var(--gold2);opacity:.8">${esc(p.soc||'ConformitÃ© du Patrimoine')}</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:11px;color:var(--gold2);opacity:.7;margin-bottom:3px">PÃ©riode</div>
          <div style="font-size:14px;font-weight:700;color:var(--gold3)">${pL}</div>
          <div style="font-size:11px;color:var(--gold2);opacity:.7;margin-top:6px">GÃ©nÃ©rÃ© le ${new Date().toLocaleDateString('fr-FR')}</div>
        </div>
      </div>
      <div style="margin-top:16px;padding-top:16px;border-top:1px solid rgba(200,169,110,.15);display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <div style="font-size:12px;color:var(--gold2);opacity:.7">Collaborateur</div>
        <div style="font-size:12px;font-weight:600;color:var(--gold3);text-align:right">${esc((p.fn||'â€”')+' '+(p.ln||''))}</div>
        <div style="font-size:12px;color:var(--gold2);opacity:.7">VÃ©hicule</div>
        <div style="font-size:12px;font-weight:600;color:var(--gold3);text-align:right">${esc(p.veh||'â€”')}</div>
        <div style="font-size:12px;color:var(--gold2);opacity:.7">BarÃ¨me</div>
        <div style="font-size:12px;font-weight:600;color:var(--gold3);text-align:right">DGFiP 2025 â€” BOI-BAREME-000001</div>
      </div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;border-bottom:1px solid var(--line)">
      <div style="padding:14px 16px;border-right:1px solid var(--line)">
        <div style="font-size:9px;font-weight:700;color:var(--fg3);letter-spacing:.08em;text-transform:uppercase;margin-bottom:5px">Trajets</div>
        <div class="serif" style="font-size:22px;font-weight:600">${trips.length}</div>
      </div>
      <div style="padding:14px 16px;border-right:1px solid var(--line)">
        <div style="font-size:9px;font-weight:700;color:var(--fg3);letter-spacing:.08em;text-transform:uppercase;margin-bottom:5px">Km total</div>
        <div class="serif" style="font-size:22px;font-weight:600">${totKm} <span style="font-size:13px;color:var(--fg3);font-family:'Plus Jakarta Sans',sans-serif">km</span></div>
      </div>
      <div style="padding:14px 16px;border-right:1px solid var(--line)">
        <div style="font-size:9px;font-weight:700;color:var(--fg3);letter-spacing:.08em;text-transform:uppercase;margin-bottom:5px">IndemnitÃ©s</div>
        <div class="serif" style="font-size:22px;font-weight:600;color:var(--gold)">${totInd.toFixed(2)} <span style="font-size:13px;font-family:'Plus Jakarta Sans',sans-serif">â‚¬</span></div>
      </div>
      <div style="padding:14px 16px">
        <div style="font-size:9px;font-weight:700;color:var(--fg3);letter-spacing:.08em;text-transform:uppercase;margin-bottom:5px">Solde dÃ»</div>
        <div class="serif" style="font-size:22px;font-weight:600;color:${totReste>0?'var(--ruby)':'var(--emerald)'}">${totReste.toFixed(2)} <span style="font-size:13px;font-family:'Plus Jakarta Sans',sans-serif">â‚¬</span></div>
      </div>
    </div>
  </div>`;

  // â”€â”€ Tableau des trajets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html+=`
  <div style="margin:0 20px 16px;background:var(--ink3);border:1px solid var(--line);border-radius:var(--r);overflow:hidden">
    <div style="overflow-x:auto">
    <table style="width:100%;border-collapse:collapse;font-size:12px;min-width:540px">
      <thead>
        <tr style="background:var(--ink4);border-bottom:1px solid var(--line2)">
          <th style="padding:10px 12px;text-align:left;font-size:9px;font-weight:700;color:var(--fg3);letter-spacing:.07em;text-transform:uppercase;white-space:nowrap">Date</th>
          <th style="padding:10px 12px;text-align:left;font-size:9px;font-weight:700;color:var(--fg3);letter-spacing:.07em;text-transform:uppercase">DÃ©part â†’ ArrivÃ©e</th>
          <th style="padding:10px 12px;text-align:left;font-size:9px;font-weight:700;color:var(--fg3);letter-spacing:.07em;text-transform:uppercase">Motif</th>
          <th style="padding:10px 8px;text-align:center;font-size:9px;font-weight:700;color:var(--fg3);letter-spacing:.07em;text-transform:uppercase;white-space:nowrap">Km</th>
          <th style="padding:10px 8px;text-align:center;font-size:9px;font-weight:700;color:var(--fg3);letter-spacing:.07em;text-transform:uppercase">CV</th>
          <th style="padding:10px 12px;text-align:right;font-size:9px;font-weight:700;color:var(--fg3);letter-spacing:.07em;text-transform:uppercase;white-space:nowrap">IndemnitÃ©</th>
          <th style="padding:10px 10px;text-align:center;font-size:9px;font-weight:700;color:var(--fg3);letter-spacing:.07em;text-transform:uppercase">Statut</th>
        </tr>
      </thead>
      <tbody>`;

  trips.forEach((t,i)=>{
    const bg = i%2===0 ? 'var(--ink3)' : 'var(--ink4)';
    const dep = t.dep.split(',')[0].trim();
    const arr = t.arr.split(',')[0].trim();
    html+=`<tr style="background:${bg};border-bottom:1px solid var(--line)">
      <td style="padding:10px 12px;color:var(--fg2);white-space:nowrap;font-size:11px">${fmtDate(t.date)}</td>
      <td style="padding:10px 12px;max-width:200px">
        <div style="font-weight:600;color:var(--fg);font-size:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(dep)}</div>
        <div style="color:var(--fg3);font-size:10px;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">â†’ ${esc(arr)}</div>
      </td>
      <td style="padding:10px 12px;color:var(--fg2);font-size:11px;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.motif)}</td>
      <td style="padding:10px 8px;text-align:center;font-weight:600;color:var(--fg);white-space:nowrap">${t.kmT}<span style="font-size:9px;color:var(--fg3)"> km${t.ar===2?' AR':''}</span></td>
      <td style="padding:10px 8px;text-align:center;color:var(--fg2);font-size:11px">${CV_L[t.cv]}</td>
      <td style="padding:10px 12px;text-align:right;font-weight:700;color:var(--gold);white-space:nowrap;font-family:'Cormorant Garamond',serif;font-size:16px">${t.ind.toFixed(2)} â‚¬</td>
      <td style="padding:10px 10px;text-align:center">${badge(t.status)}</td>
    </tr>`;
  });

  html+=`
      </tbody>
      <tfoot>
        <tr style="background:var(--ink5);border-top:2px solid var(--line2)">
          <td colspan="3" style="padding:12px 12px;font-weight:700;font-size:12px;color:var(--fg)">TOTAL â€” ${trips.length} trajet(s)</td>
          <td style="padding:12px 8px;text-align:center;font-weight:700;color:var(--fg)">${totKm} km</td>
          <td></td>
          <td style="padding:12px 12px;text-align:right;font-weight:700;color:var(--gold);font-family:'Cormorant Garamond',serif;font-size:18px">${totInd.toFixed(2)} â‚¬</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
    </div>
  </div>`;

  // â”€â”€ Mention lÃ©gale â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html+=`
  <div style="margin:0 20px 12px;background:var(--gold-bg);border:1px solid var(--gold-ring);border-radius:var(--r);padding:14px 16px">
    <div style="font-size:11px;color:var(--gold2);line-height:1.7">
      <strong>Base lÃ©gale :</strong> ArrÃªtÃ© du 27 mars 2025 fixant les barÃ¨mes kilomÃ©triques â€” BOI-BAREME-000001.<br>
      IndemnitÃ©s calculÃ©es au barÃ¨me officiel DGFiP 2025. Frais professionnels rÃ©els dÃ©ductibles du rÃ©sultat imposable (Art. 83 3Â° CGI).<br>
      Document Ã©tabli le ${new Date().toLocaleDateString('fr-FR')} Â· ${esc(p.soc||'ConformitÃ© du Patrimoine')}
    </div>
  </div>
  <div style="padding:0 20px 20px" class="no-print">
    <button class="btn btn-gold" id="btn-pdf" style="width:100%;padding:15px;font-size:15px;gap:10px">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
      Exporter PDF comptable
    </button>
  </div>`;

  out.innerHTML=html;
  out.querySelector('#btn-pdf')?.addEventListener('click',()=>exportPDF(trips,p,pL,yr,totKm,totInd,totPaid));
  toast('Rapport gÃ©nÃ©rÃ© â€” cliquez "Exporter PDF" âœ“','ok');
}

function printReport(){
  // S'assurer que le contenu print est gÃ©nÃ©rÃ©
  const pd=document.getElementById('print-content');
  if(!pd){ toast('GÃ©nÃ©rez d\'abord le rapport','err'); return; }
  window.print();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT / IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let selExpType='backup';
function selExp(type){
  selExpType=type;
  document.querySelectorAll('.exp-opt').forEach(el=>el.classList.toggle('sel',el.dataset.type===type));
  document.getElementById('exp-period').style.display=type==='backup'?'none':'block';
}
function doExport(){
  if(selExpType==='backup') exportJSON();
  else exportCSV();
}
function exportJSON(){
  const blob=new Blob([JSON.stringify(DB,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url; a.download=`km-pro-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click(); URL.revokeObjectURL(url);
  closeSheet('sh-export'); toast('Sauvegarde exportÃ©e âœ“','ok');
}
function exportCSV(){
  const {ts}=getFilteredTrips();
  if(!ts.length){ toast('Aucun trajet pour cette pÃ©riode','err'); return; }
  const h=['Date','AssociÃ©','DÃ©part','ArrivÃ©e','Motif','Km aller','Type','Km total','CV','VÃ©hicule','IndemnitÃ© â‚¬','RemboursÃ© â‚¬','Reste â‚¬','Statut','Notes'];
  const rows=ts.map(t=>[fmtDate(t.date),nameOf(t.assoc),`"${t.dep}"`,`"${t.arr}"`,`"${t.motif}"`,t.km,t.ar===2?'AR':'Simple',t.kmT,CV_L[t.cv],t.veh||'',t.ind.toFixed(2),(t.paid||0).toFixed(2),(t.ind-(t.paid||0)).toFixed(2),t.status,`"${t.notes||''}"`]);
  const csv=[h,...rows].map(r=>r.join(';')).join('\n');
  const blob=new Blob(['\uFEFF'+csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`km-pro-compta-${new Date().toISOString().slice(0,10)}.csv`;
  a.click(); URL.revokeObjectURL(url);
  closeSheet('sh-export'); toast('CSV exportÃ© âœ“','ok');
}
function getFilteredTrips(){
  const per=getVal('ep-per')||'tout', yr=parseInt(getVal('ep-yr')||new Date().getFullYear());
  let mD=1,mF=12;
  if(per==='mois'){const n=new Date();mD=mF=n.getMonth()+1;}
  if(per==='trim1'){mD=1;mF=3;} if(per==='trim2'){mD=4;mF=6;}
  if(per==='trim3'){mD=7;mF=9;} if(per==='trim4'){mD=10;mF=12;}
  let ts=DB.trips;
  if(per!=='tout') ts=ts.filter(t=>{const d=new Date(t.date);return d.getFullYear()===yr&&d.getMonth()+1>=mD&&d.getMonth()+1<=mF;});
  return{ts:ts.sort((a,b)=>new Date(a.date)-new Date(b.date))};
}
function triggerImport(){
  document.getElementById('file-import').click();
}

function doImport(e){
  const file=e.target.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const imp=JSON.parse(ev.target.result);
      if(!imp || typeof imp !== 'object') throw new Error('invalid');

      // Auto-dÃ©tection : si le profil du fichier correspond au profil actuel â†’ restauration perso
      // sinon â†’ import d'un associÃ©
      const srcProfil = imp.profil||{};
      const srcName = ((srcProfil.fn||'')+' '+(srcProfil.ln||'')).trim().toLowerCase();
      const myName  = ((DB.profil.fn||'')+' '+(DB.profil.ln||'')).trim().toLowerCase();
      const isSelf  = srcName && myName && srcName === myName;

      if(isSelf){
        importSelfData(imp);
      } else {
        importAssocData(imp, file.name);
      }
    }catch(err){
      console.error(err);
      toast('Fichier JSON invalide ou corrompu','err');
    }
  };
  reader.readAsText(file);
  e.target.value='';
}

function importSelfData(imp){
  // Restauration classique : fusion sans Ã©crasement par ID
  const exTrips  = new Set(DB.trips.map(t=>t.id));
  const exPay    = new Set(DB.payments.map(p=>p.id));
  let nTrips=0, nPay=0;

  (imp.trips||[]).forEach(t=>{
    if(!exTrips.has(t.id)){ DB.trips.push(t); nTrips++; }
  });
  (imp.payments||[]).forEach(p=>{
    if(!exPay.has(p.id)){ DB.payments.push(p); nPay++; }
  });

  // Profil : fusion des favoris uniquement (pas Ã©craser le profil perso)
  if(imp.profil?.favoris){
    const exFav = new Set((DB.profil.favoris||[]).map(f=>f.label+'|'+f.addr));
    (imp.profil.favoris).forEach(f=>{
      if(!exFav.has(f.label+'|'+f.addr)) DB.profil.favoris.push(f);
    });
  }

  saveDB(); renderAll(); closeSheet('sh-profil');
  toast(`Restauration : +${nTrips} trajet(s), +${nPay} versement(s) fusionnÃ©(s) âœ“`,'ok');
}

function importAssocData(imp, filename){
  // DÃ©tecter le nom de l'associÃ© depuis le profil de la sauvegarde
  const srcProfil = imp.profil||{};
  const srcName = ((srcProfil.fn||'')+' '+(srcProfil.ln||'')).trim();
  const detectedName = srcName || filename.replace(/\.json$/i,'').replace(/[-_]/g,' ');

  // Demander confirmation avec preview
  const nTrips  = (imp.trips||[]).length;
  const nPay    = (imp.payments||[]).length;
  const exTrips = new Set(DB.trips.map(t=>t.id));
  const exPay   = new Set(DB.payments.map(p=>p.id));
  const newTrips  = (imp.trips||[]).filter(t=>!exTrips.has(t.id));
  const newPay    = (imp.payments||[]).filter(p=>!exPay.has(p.id));

  const msg = [
    `ğŸ“‚ Fichier : ${filename}`,
    `ğŸ‘¤ AssociÃ© dÃ©tectÃ© : ${detectedName||'(inconnu)'}`,
    ``,
    `Dans ce fichier :`,
    `  â€¢ ${nTrips} trajet(s) total`,
    `  â€¢ ${nPay} versement(s) total`,
    ``,
    `Nouveaux Ã©lÃ©ments Ã  ajouter :`,
    `  âœ… ${newTrips.length} trajet(s) nouveau(x)`,
    `  âœ… ${newPay.length} versement(s) nouveau(x)`,
    `  â­ï¸ ${nTrips-newTrips.length} trajet(s) dÃ©jÃ  prÃ©sent(s) â€” ignorÃ©s`,
    ``,
    `Continuer l'import ?`
  ].join('\n');

  if(!confirm(msg)) return;

  // Import avec rÃ©attribution de l'associÃ©
  // â†’ on garde le champ "assoc" original de chaque trajet pour prÃ©server
  //   les donnÃ©es de l'associÃ© (il peut avoir plusieurs associÃ©s lui aussi).
  //   MAIS si le champ assoc est 'me', on le remplace par le nom dÃ©tectÃ©.
  let nAddedTrips=0, nAddedPay=0;

  newTrips.forEach(t=>{
    const tripCopy = {...t};
    // Si l'associÃ© se dÃ©signait 'me', le remplacer par son vrai nom
    if(tripCopy.assoc === 'me' || !tripCopy.assoc){
      tripCopy.assoc = srcName || detectedName || 'AssociÃ© importÃ©';
    }
    // Marquer comme importÃ© pour traÃ§abilitÃ©
    tripCopy._src = srcName || detectedName;
    tripCopy._importedAt = new Date().toISOString();
    DB.trips.push(tripCopy);
    nAddedTrips++;
  });

  newPay.forEach(p=>{
    const payCopy = {...p};
    if(payCopy.assoc === 'me' || !payCopy.assoc){
      payCopy.assoc = srcName || detectedName || 'AssociÃ© importÃ©';
    }
    payCopy._src = srcName || detectedName;
    payCopy._importedAt = new Date().toISOString();
    DB.payments.push(payCopy);
    nAddedPay++;
  });

  saveDB(); renderAll(); closeSheet('sh-profil');

  if(nAddedTrips===0 && nAddedPay===0){
    toast('Tout Ã©tait dÃ©jÃ  Ã  jour â€” aucun doublon ajoutÃ© âœ“','tip');
  } else {
    toast(`Import associÃ© : +${nAddedTrips} trajet(s), +${nAddedPay} versement(s) âœ“`,'ok');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchScreen(name){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(n=>n.classList.remove('active'));
  document.getElementById('s-'+name)?.classList.add('active');
  document.getElementById('ni-'+name)?.classList.add('active');
  const fabMap = {home:openNewTrajet,trajets:openNewTrajet,remb:openRembSheet,stats:()=>renderStats(),rapport:genReport};
  const fabLbl = {home:'+',trajets:'+',remb:'â‚¬',stats:'ğŸ“ˆ',rapport:'ğŸ“‹'};
  const fab=document.getElementById('fab');
  fab.textContent=fabLbl[name]||'+';
  fab.onclick=fabMap[name]||openNewTrajet;
  if(name==='stats') setTimeout(renderStats,80);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openSheet(id){ document.getElementById(id).classList.add('open'); document.body.style.overflow='hidden'; }
function closeSheet(id){
  document.getElementById(id).classList.remove('open'); document.body.style.overflow='';
  if(id==='sh-trajet') hideMap();
}
document.querySelectorAll('.overlay').forEach(el=>el.addEventListener('click',e=>{ if(e.target===el) closeSheet(el.id); }));

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Convertit '2025-03-15' â†’ '15/03/2025'
function fmtDate(iso){
  if(!iso) return '';
  const [y,m,d]=iso.split('-');
  return `${d}/${m}/${y}`;
}

function badge(s){ const m={wait:['b-wait','â³ En attente'],part:['b-part','â—‘ Partiel'],done:['b-done','âœ“ RemboursÃ©']};const[cls,lbl]=m[s]||['b-wait','?'];return`<span class="badge ${cls}">${lbl}</span>`; }
function dr(l,v){ return `<div class="dr"><span class="dr-l">${l}</span><span class="dr-v">${v}</span></div>`; }
function sr(l,v){ return `<div class="stat-r"><span class="stat-l">${l}</span><span class="stat-v">${v}</span></div>`; }
function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function uid(){ return Date.now().toString(36)+Math.random().toString(36).slice(2); }
function getVal(id){ const el=document.getElementById(id); return el?el.value:''; }
function setVal(id,v){ const el=document.getElementById(id); if(el) el.value=v; }
function clearAll(){
  if(!confirm('Effacer tous les trajets et versements ?')) return;
  DB.trips=[]; DB.payments=[]; saveDB(); renderAll(); toast('DonnÃ©es effacÃ©es','tip');
}
function toast(msg,type='tip'){
  const wrap=document.getElementById('toasts');
  const el=document.createElement('div');
  el.className=`toast ${type}`;
  el.innerHTML=`<span>${{ok:'âœ“',err:'âœ—',tip:'â„¹'}[type]||'â„¹'}</span>${msg}`;
  wrap.appendChild(el);
  setTimeout(()=>{ el.style.transition='.3s'; el.style.opacity='0'; el.style.transform='translateY(-8px)'; setTimeout(()=>el.remove(),300); }, 3200);
}


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIN LOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pinBuffer = '';
let pinMode = 'check'; // 'check' | 'setup1' | 'setup2'
let pinFirst = '';

function pinKey(d){
  if(pinBuffer.length >= 4) return;
  pinBuffer += d;
  updatePinDots();
  if(pinBuffer.length === 4) setTimeout(validatePin, 120);
}
function pinDel(){
  pinBuffer = pinBuffer.slice(0,-1);
  updatePinDots();
  clearPinErr();
}
function updatePinDots(state){
  for(let i=0;i<4;i++){
    const dot = document.getElementById('pd'+i);
    dot.className = 'pin-dot' + (i<pinBuffer.length?' filled':'') + (state==='err'?' error':'');
  }
}
function clearPinErr(){ document.getElementById('pin-err').textContent=''; }
function showPinErr(msg){
  document.getElementById('pin-err').textContent = msg;
  updatePinDots('err');
  pinBuffer='';
  setTimeout(()=>{ updatePinDots(); clearPinErr(); }, 900);
}
function validatePin(){
  const stored = localStorage.getItem('kmpro_pin');
  if(pinMode === 'check'){
    if(pinBuffer === stored){
      // SuccÃ¨s â€” masquer l'Ã©cran PIN
      sessionStorage.setItem('kmpro_unlocked','1');
      document.getElementById('pin-screen').classList.add('hidden');
      setTimeout(()=>document.getElementById('pin-screen').style.display='none', 350);
      pinBuffer='';
    } else {
      showPinErr('Code incorrect');
    }
  } else if(pinMode === 'setup1'){
    pinFirst = pinBuffer;
    pinBuffer='';
    document.getElementById('pin-label').textContent='Confirmez le code';
    updatePinDots();
    pinMode = 'setup2';
  } else if(pinMode === 'setup2'){
    if(pinBuffer === pinFirst){
      localStorage.setItem('kmpro_pin', pinBuffer);
      toast('Code PIN configurÃ© âœ“','ok');
      pinBuffer=''; pinMode='check'; pinFirst='';
      closeSheet('sh-pin-setup');
      // Mettre Ã  jour le bouton dans profil
      renderPinBtn();
    } else {
      showPinErr('Les codes ne correspondent pas');
      pinMode='setup1'; pinFirst='';
      document.getElementById('pin-label').textContent='Choisissez un code Ã  4 chiffres';
    }
  }
}
function openPinSetup(){
  pinMode='setup1'; pinBuffer=''; pinFirst='';
  document.getElementById('pin-label').textContent='Choisissez un code Ã  4 chiffres';
  updatePinDots(); clearPinErr();
  // RÃ©utiliser le pin-screen en modal
  const ps = document.getElementById('pin-screen');
  ps.style.display='flex'; ps.classList.remove('hidden');
  ps.style.background='rgba(8,9,9,0.97)';
  // Ajouter bouton annuler
  if(!document.getElementById('pin-cancel')){
    const btn = document.createElement('button');
    btn.id='pin-cancel'; btn.textContent='Annuler';
    btn.style.cssText='margin-top:24px;background:none;border:none;color:var(--fg3);font-size:14px;font-weight:600;cursor:pointer;font-family:"Plus Jakarta Sans",sans-serif';
    btn.onclick=()=>{ pinBuffer=''; pinMode='check'; pinFirst='';
      document.getElementById('pin-label').textContent='Entrez votre code';
      ps.classList.add('hidden');
      setTimeout(()=>{ ps.style.display='none'; ps.style.background='var(--ink)'; },350);
    };
    ps.appendChild(btn);
  }
}
function renderPinBtn(){
  const wrap = document.getElementById('pin-btn-wrap');
  if(!wrap) return;
  const has = !!localStorage.getItem('kmpro_pin');
  wrap.innerHTML = has
    ? `<button class="btn btn-ink" style="flex:1;padding:11px;font-size:13px;border-radius:12px" onclick="openPinSetup()">ğŸ”‘ Changer le code PIN</button>
       <button class="btn btn-danger" style="flex:1;padding:11px;font-size:13px;border-radius:12px" onclick="removePin()">ğŸ”“ DÃ©sactiver</button>`
    : `<button class="btn btn-gold" style="width:100%;padding:12px;border-radius:12px" onclick="openPinSetup()">ğŸ”’ Activer le verrouillage PIN</button>`;
}
function removePin(){
  if(!confirm('DÃ©sactiver le verrouillage par code ?')) return;
  localStorage.removeItem('kmpro_pin');
  renderPinBtn(); toast('Verrouillage dÃ©sactivÃ©','tip');
}
function initPin(){
  const stored = localStorage.getItem('kmpro_pin');
  const unlocked = sessionStorage.getItem('kmpro_unlocked');
  if(!stored || unlocked){
    // Pas de PIN ou dÃ©jÃ  dÃ©verrouillÃ© dans cette session
    document.getElementById('pin-screen').style.display='none';
    return;
  }
  // Afficher l'Ã©cran PIN
  document.getElementById('pin-label').textContent='Entrez votre code';
  pinMode='check'; pinBuffer='';
}



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPORT PDF COMPTABLE (jsPDF + autoTable)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPDF(trips, p, pL, yr, totKm, totInd, totPaid){
  if(typeof window.jspdf === 'undefined' && typeof jspdf === 'undefined'){
    toast('BibliothÃ¨que PDF non chargÃ©e â€” vÃ©rifiez votre connexion','err'); return;
  }
  const { jsPDF } = window.jspdf || jspdf;
  const doc = new jsPDF({ orientation:'landscape', unit:'mm', format:'a4' });
  const W = doc.internal.pageSize.getWidth();
  const pageH = doc.internal.pageSize.getHeight();
  const gold = [200, 169, 110];
  const ink  = [14, 16, 18];
  const fg2  = [154, 160, 170];
  const em   = [77, 184, 135];
  const today = new Date().toLocaleDateString('fr-FR');

  // â”€â”€ En-tÃªte â”€â”€
  doc.setFillColor(...ink);
  doc.rect(0, 0, W, 24, 'F');
  doc.setFillColor(...gold);
  doc.rect(0, 0, 3, 24, 'F');

  doc.setFont('helvetica','bold');
  doc.setFontSize(16);
  doc.setTextColor(255,255,255);
  doc.text('KM Pro', 10, 10);
  doc.setFontSize(9);
  doc.setFont('helvetica','normal');
  doc.setTextColor(...fg2);
  doc.text('Note de frais kilomÃ©triques', 10, 16.5);

  doc.setFont('helvetica','bold');
  doc.setFontSize(10);
  doc.setTextColor(255,255,255);
  doc.text((p.soc||'ConformitÃ© du Patrimoine').toUpperCase(), W/2, 10, {align:'center'});
  doc.setFont('helvetica','normal');
  doc.setFontSize(9);
  doc.setTextColor(...fg2);
  doc.text(`PÃ©riode : ${pL}  Â·  Ã‰tablie par : ${((p.fn||'')+' '+(p.ln||'')).trim()}${p.veh?' Â· VÃ©h. : '+p.veh:''}`, W/2, 16.5, {align:'center'});

  doc.setFontSize(8);
  doc.setTextColor(...fg2);
  doc.text(`GÃ©nÃ©rÃ© le ${today}`, W-10, 10, {align:'right'});
  doc.setFontSize(7);
  doc.text('BarÃ¨me DGFiP 2025 Â· BOI-BAREME-000001', W-10, 15.5, {align:'right'});

  // â”€â”€ KPI band â”€â”€
  const kpiY = 28;
  const kpiW = (W - 20) / 4;
  const kpis = [
    { l:'Km parcourus', v:totKm+' km', c:gold },
    { l:'IndemnitÃ©s dues', v:totInd.toFixed(2)+' â‚¬', c:gold },
    { l:'RemboursÃ©', v:totPaid.toFixed(2)+' â‚¬', c:em },
    { l:'Solde restant', v:(totInd-totPaid).toFixed(2)+' â‚¬', c: totInd-totPaid>0.01?[224,85,85]:em }
  ];
  kpis.forEach((k,i)=>{
    const x=10 + i*kpiW;
    doc.setFillColor(22,26,30);
    doc.roundedRect(x, kpiY, kpiW-4, 14, 2, 2, 'F');
    doc.setFillColor(...k.c);
    doc.rect(x, kpiY, 2, 14, 'F');
    doc.setFontSize(7);
    doc.setFont('helvetica','bold');
    doc.setTextColor(...fg2);
    doc.text(k.l.toUpperCase(), x+5, kpiY+5);
    doc.setFontSize(12);
    doc.setFont('helvetica','bold');
    doc.setTextColor(...k.c);
    doc.text(k.v, x+5, kpiY+11.5);
  });

  // â”€â”€ Tableau â”€â”€
  const head = [['#','Date trajet','DÃ©part','ArrivÃ©e','Motif professionnel','Km','Type','Total km','CV','IndemnitÃ© â‚¬','Date rembours.','RemboursÃ© â‚¬','Solde â‚¬']];
  // Chercher la date du dernier versement pour ce trajet
  const payDateOf = (tripId) => {
    const pays = DB.payments
      .filter(p => (p.tripIds||[]).includes(tripId))
      .sort((a,b) => new Date(b.date)-new Date(a.date));
    // Fallback: versements sans tripIds liÃ©s Ã  cet associÃ©
    if(!pays.length){
      const t = DB.trips.find(x=>x.id===tripId);
      if(t && t.paid > 0){
        const byAssoc = DB.payments
          .filter(p=>p.assoc===t.assoc)
          .sort((a,b)=>new Date(b.date)-new Date(a.date));
        return byAssoc.length ? fmtDate(byAssoc[0].date) : 'â€”';
      }
    }
    return pays.length ? fmtDate(pays[0].date) : 'â€”';
  };

  const body = trips.map((t,i)=>[
    String(i+1),
    fmtDate(t.date),
    t.dep.split(',').slice(0,2).join(', ').slice(0,35),
    t.arr.split(',').slice(0,2).join(', ').slice(0,35),
    (t.motif||'').slice(0,40),
    String(t.km),
    t.ar===2?'A/R':'Aller',
    String(t.kmT),
    {3:'3CV',4:'4CV',5:'5CV',6:'6CV',7:'7CV+'}[t.cv]||'5CV',
    t.ind.toFixed(2),
    payDateOf(t.id),
    (t.paid||0).toFixed(2),
    (t.ind-(t.paid||0)).toFixed(2),
  ]);

  // Ligne totaux
  body.push([
    '','','','','TOTAL', '', '', String(totKm), '', totInd.toFixed(2), '', totPaid.toFixed(2), (totInd-totPaid).toFixed(2)
  ]);

  doc.autoTable({
    head, body,
    startY: kpiY + 18,
    margin: { left:10, right:10 },
    styles: { fontSize:7.5, cellPadding:2.5, lineColor:[30,35,40], lineWidth:0.2, textColor:[230,232,235], fillColor:[14,16,18] },
    headStyles: { fillColor:[22,26,30], textColor:[200,169,110], fontStyle:'bold', fontSize:7, halign:'center', lineWidth:0.4, lineColor:[200,169,110] },
    alternateRowStyles: { fillColor:[18,21,24] },
    columnStyles: {
      0:  { halign:'center', cellWidth:7 },
      1:  { cellWidth:17 },
      2:  { cellWidth:32 },
      3:  { cellWidth:32 },
      4:  { cellWidth:38 },
      5:  { halign:'center', cellWidth:10 },
      6:  { halign:'center', cellWidth:11 },
      7:  { halign:'center', cellWidth:13, fontStyle:'bold' },
      8:  { halign:'center', cellWidth:9 },
      9:  { halign:'right', cellWidth:17, textColor:[200,169,110], fontStyle:'bold' },
      10: { halign:'center', cellWidth:17, textColor:[154,160,170] },
      11: { halign:'right', cellWidth:17, textColor:[77,184,135] },
      12: { halign:'right', cellWidth:15 },
    },
    didParseCell(data){
      // Ligne totaux
      if(data.row.index === body.length - 1){
        data.cell.styles.fillColor = [26,30,34];
        data.cell.styles.fontStyle = 'bold';
        if(data.column.index===4) data.cell.styles.textColor = [200,169,110];
      }
      // Solde colonne 11
      if(data.column.index===12 && data.section==='body' && data.row.index < body.length-1){
        const v=parseFloat(data.cell.raw)||0;
        data.cell.styles.textColor = v>0.01 ? [224,85,85] : [77,184,135];
      }
    },
    willDrawPage(data){
      // RÃ©pÃ©ter l'en-tÃªte sur chaque page
      if(data.pageNumber > 1){
        doc.setFillColor(...ink);
        doc.rect(0,0,W,12,'F');
        doc.setFillColor(...gold);
        doc.rect(0,0,3,12,'F');
        doc.setFont('helvetica','bold');
        doc.setFontSize(8);
        doc.setTextColor(255,255,255);
        doc.text('KM Pro â€” '+pL, 8, 8);
        doc.setFont('helvetica','normal');
        doc.setTextColor(...fg2);
        doc.text(`Page ${data.pageNumber}`, W-8, 8, {align:'right'});
      }
    }
  });

  // â”€â”€ Pied de page â”€â”€
  const finalY = doc.lastAutoTable.finalY + 6;
  if(finalY < pageH - 20){
    doc.setFontSize(7);
    doc.setTextColor(...fg2);
    doc.setFont('helvetica','normal');
    const legal=`IndemnitÃ©s calculÃ©es conformÃ©ment au barÃ¨me kilomÃ©trique DGFiP 2025 (BOI-BAREME-000001, arrÃªtÃ© du 27 mars 2025). Frais professionnels rÃ©els dÃ©ductibles du rÃ©sultat imposable.`;
    doc.text(legal, 10, finalY, {maxWidth: W-20});
  }

  // NumÃ©ros de page sur toutes les pages
  const totalPages = doc.internal.getNumberOfPages();
  for(let pg=1; pg<=totalPages; pg++){
    doc.setPage(pg);
    doc.setFontSize(7);
    doc.setTextColor(...fg2);
    doc.text(`Page ${pg} / ${totalPages}`, W-10, pageH-5, {align:'right'});
    doc.setFillColor(...gold);
    doc.rect(0, pageH-1.5, W, 1.5, 'F');
  }

  // Sauvegarde
  const nom=`km-pro_${pL.replace(/\s/g,'-').toLowerCase()}_${today.replace(/\//g,'-')}.pdf`;
  doc.save(nom);
  toast('PDF exportÃ© âœ“','ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded',()=>{
  loadDB(); loadProfil(); renderAll(); selExp('backup');
  initPin(); renderPinBtn();
  // iOS install hint
  if(/iphone|ipad|ipod/i.test(navigator.userAgent)&&!window.navigator.standalone)
    document.getElementById('install-hint').classList.add('show');
  // Premier lancement â€” ouvrir profil
  if(!DB.profil.fn) setTimeout(()=>openSheet('sh-profil'),800);
});
</script>
</body>
</html>
